<project name="salesforce" default="validate" basedir="." xmlns:sf="antlib:com.salesforce">

    <taskdef uri="antlib:com.salesforce"
        resource="com/salesforce/antlib.xml"
        classpath="${basedir}/lib/ant-salesforce.jar"/>

    <property file="${basedir}/build.properties"/>
    <property environment="env"/>

    <import file="${basedir}/lib/exec_anon.xml"/>
    <import file="${basedir}/lib/deploy.xml"/>
    <import file="${basedir}/lib/undeploy.xml"/>
    <import file="${basedir}/lib/run_tests.xml"/>
    <import file="${basedir}/lib/package_generator.xml"/>    

    <target name="retrieve" description="Recreate the deployment directory and retrieve all metadata from your org">
        <echo level="info">Performing a retrieve</echo>     
        <mkdir dir="${basedir}/${sfdc.retrieveTarget}"/>
        <sf:retrieve username="${sf.username}"
                     password="${sf.password}"
                     serverurl="${sf.serverurl}"
                     retrieveTarget="${basedir}/${sfdc.retrieveTarget}"
                     unpackaged="src/package.xml"
                     pollWaitMillis="${sfdc.pollWaitMillis}"
                     maxPoll="${sfdc.maxPoll}"/>
        <delete includeemptydirs="true">
            <fileset dir="src" includes="**/*"/>
        </delete>                     
        <move file="${basedir}/${sfdc.retrieveTarget}" tofile="src"/>
    </target>

    <target name="deploy"> 
      <echo level="info">Performing the deploy</echo>     
      <sf:deploy username="${sf.username}" 
        password="${sf.password}" 
        serverurl="${sf.serverurl}" 
        runAllTests="true"
        testLevel="RunLocalTests"
        logType="Detail"
        allowMissingFiles="true"
        autoUpdatePackage="true"
        ignoreWarnings="true"
        deployRoot="${basedir}/src"
        pollWaitMillis="${sfdc.pollWaitMillis}"
        maxPoll="${sfdc.maxPoll}"/>
    </target>

    <target name="validate">
      <echo level="info">Testing the deployment</echo>
      <sf:deploy username="${sf.username}" 
        password="${sf.password}" 
        serverurl="${sf.serverurl}" 
        checkOnly="true"
        runAllTests="true"
        logType="Debugonly"
        testLevel="RunLocalTests"
        allowMissingFiles="true"
        autoUpdatePackage="true"
        ignoreWarnings="true"
        deployRoot="src"
        pollWaitMillis="${sfdc.pollWaitMillis}"
        maxPoll="${sfdc.maxPoll}"/>
    </target>
	
	
    <target name="validateBET">
      <echo level="info">Testing the deployment of BET</echo>
      <sf:deploy username="${sf.username}" 
        password="${sf.password}" 
        serverurl="${sf.serverurl}" 
        checkOnly="true"
        runAllTests="true"
        logType="Debugonly"
        testLevel="RunSpecifiedTests"
        allowMissingFiles="true"
        autoUpdatePackage="true"
        ignoreWarnings="true"
        deployRoot="src"
        pollWaitMillis="${sfdc.pollWaitMillis}"
        maxPoll="${sfdc.maxPoll}">
			<runTest>BET_*</runTest>
			<runTest>uw_*</runTest>
		</sf:deploy>
    </target>

    <target name="deployRunAllTests"> 
      <echo level="info">Performing the tests and deploy</echo>     
      <sf:deploy username="${sf.username}" 
        password="${sf.password}" 
        serverurl="${sf.serverurl}" 
        runAllTests="false"
        logType="Detail"
        allowMissingFiles="true"
        autoUpdatePackage="true"
        ignoreWarnings="true"
        deployRoot="${basedir}/src"
        pollWaitMillis="${sfdc.pollWaitMillis}"
        maxPoll="${sfdc.maxPoll}"/>
    </target>  

    <target name="undeploy">
      <echo level="info">Performing undeploy - DESTRUCTIVE CHANGE</echo>  
      <sf:deploy username="${sf.username}" 
        password="${sf.password}" 
        serverurl="${sf.serverurl}" 
        ignoreWarnings="true"
        deployRoot="${basedir}/undeploy"
        pollWaitMillis="${sfdc.pollWaitMillis}"
        maxPoll="${sfdc.maxPoll}"/>        
    </target>

</project>
