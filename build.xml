<project name="salesforce" default="validate" basedir="." xmlns:sf="antlib:com.salesforce">

    <taskdef uri="antlib:com.salesforce"
        resource="com/salesforce/antlib.xml"
        classpath="${basedir}/lib/ant-salesforce.jar"/>

    <property file="${basedir}/build.properties"/>
    <property environment="env"/>

    <import file="${basedir}/lib/exec_anon.xml"/>
    <import file="${basedir}/lib/deploy.xml"/>
    <import file="${basedir}/lib/undeploy.xml"/>
    <import file="${basedir}/lib/run_tests.xml"/>
    <import file="${basedir}/lib/package_generator.xml"/>    

    <target name="retrieve" description="Recreate the deployment directory and retrieve all metadata from your org">
        <echo level="info">Performing a retrieve</echo>     
        <mkdir dir="${basedir}/${sfdc.retrieveTarget}"/>
        <sf:retrieve username="${sf.username}"
                     password="${sf.password}"
                     serverurl="${sf.serverurl}"
                     retrieveTarget="${basedir}/${sfdc.retrieveTarget}"
                     unpackaged="src/package.xml"
                     pollWaitMillis="${sfdc.pollWaitMillis}"
                     maxPoll="${sfdc.maxPoll}"/>
        <delete includeemptydirs="true">
            <fileset dir="src" includes="**/*"/>
        </delete>                     
        <move file="${basedir}/${sfdc.retrieveTarget}" tofile="src"/>
    </target>

    <target name="deploy"> 
      <echo level="info">Performing the deploy</echo>     
      <sf:deploy username="${sf.username}" 
        password="${sf.password}" 
        serverurl="${sf.serverurl}" 
        runAllTests="false"
        testLevel="NoTestRun"
        logType="Detail"
        allowMissingFiles="true"
        autoUpdatePackage="true"
        ignoreWarnings="true"
        deployRoot="${basedir}/src"
        pollWaitMillis="${sfdc.pollWaitMillis}"
        maxPoll="${sfdc.maxPoll}"/>
    </target>

    <target name="validate">
      <echo level="info">Testing the deployment</echo>
      <sf:deploy username="${sf.username}" 
        password="${sf.password}" 
        serverurl="${sf.serverurl}" 
        checkOnly="true"
        runAllTests="true"
        logType="Debugonly"
        testLevel="RunLocalTests"
        allowMissingFiles="true"
        autoUpdatePackage="true"
        ignoreWarnings="true"
        deployRoot="src"
        pollWaitMillis="${sfdc.pollWaitMillis}"
        maxPoll="${sfdc.maxPoll}"/>
    </target>

    <target name="deployRunAllTests"> 
      <echo level="info">Performing the tests and deploy</echo>     
      <sf:deploy username="${sf.username}" 
        password="${sf.password}" 
        serverurl="${sf.serverurl}"
        checkOnly="false"
        runAllTests="true"
        testLevel="RunLocalTests"
        logType="Detail"
        allowMissingFiles="true"
        autoUpdatePackage="true"
        ignoreWarnings="true"
        deployRoot="${basedir}/src"
        pollWaitMillis="${sfdc.pollWaitMillis}"
        maxPoll="${sfdc.maxPoll}"/>
    </target>  

    <target name="undeploy">
      <echo level="info">Performing undeploy - DESTRUCTIVE CHANGE</echo>  
      <sf:deploy username="${sf.username}" 
        password="${sf.password}" 
        serverurl="${sf.serverurl}" 
        ignoreWarnings="true"
        deployRoot="${basedir}/undeploy"
        pollWaitMillis="${sfdc.pollWaitMillis}"
        maxPoll="${sfdc.maxPoll}"/>        
    </target>

    <target name="sandbox-setup" depends="enable-deploy-user">
      <echo level="info">CI Sandbox setup scripts to allow data dependent tests to pass</echo>   
      <antcall target="ExecAnonScript">
        <param name="what" value="${basedir}/scripts/sandbox-setup.apex" />
        <param name="username" value="${sf.username}" />
        <param name="password" value="${sf.password}" />
        <param name="serverurl" value="${sf.serverurl}"/>
      </antcall>
    </target>    
    
    <target name="enable-deploy-user">
      <echo level="info">Enable CI deploy user which is used to run unit tests</echo>   
      <antcall target="ExecAnonScript">
        <param name="what" value="${basedir}/scripts/enable-deploy-user.apex" />
        <param name="username" value="${sf.username}" />
        <param name="password" value="${sf.password}" />
        <param name="host" value="${sf.serverurl}"/>
      </antcall>
    </target> 

    <target name="retrieveAll" description="Recreate the deployment directory and retrieve all metadata from your org">
        <echo level="info">Performing a retrieve</echo>     
        <mkdir dir="${basedir}/${sfdc.retrieveTarget}"/>
        <sf:retrieve username="${sf.username}"
                     password="${sf.password}"
                     serverurl="${sf.serverurl}"
                     retrieveTarget="${basedir}/${sfdc.retrieveTarget}"
                     unpackaged="src/packageAll.xml"
                     pollWaitMillis="${sfdc.pollWaitMillis}"
                     maxPoll="${sfdc.maxPoll}"/>
        <delete includeemptydirs="true">
            <fileset dir="src" includes="**/*"/>
        </delete>                     
        <move file="${basedir}/${sfdc.retrieveTarget}" tofile="src"/>
    </target>

    <target name="cleanup">
      <replaceregexp byline="true" flags="g">
        <regexp pattern="&lt;icon&gt;.*&lt;/icon&gt;.*$"/>
        <substitution expression=""/>
        <fileset dir="${basedir}">
          <include name="**/*.tab"/>
        </fileset>
      </replaceregexp>
      <replaceregexp byline="false" flags="gm">
        <regexp pattern="[\s].*listViews(.*[\s]){2}.*ALL(.*\s){12}"/>
        <substitution expression=""/>
        <fileset dir="${basedir}">
          <include name="**/Asset__c.object"/>
        </fileset>
      </replaceregexp>     
      <replaceregexp byline="false" flags="gm">
        <regexp pattern="[\s].*userPermissions.*[\s].*[\s].*(ViewAllData|EditBillingInfo|ManageSandboxes|ManageTranslation|CustomizeApplication).*[\s].*"/>
        <substitution expression=""/>
        <fileset dir="${basedir}">
          <include name="**/*.profile"/>
          <include name="**/*.permissionset"/>
        </fileset>
      </replaceregexp>                  

      <delete><fileset dir="${basedir}" includes="**/agf__ADM_Work__c.object"/></delete>
      <delete><fileset dir="${basedir}" includes="**/KnowledgeArticleVersion.object"/></delete>
      <delete><fileset dir="${basedir}" includes="**/SocialPost.workflow"/></delete>
      <delete><fileset dir="${basedir}" includes="**/SocialPersona.workflow"/></delete>
      <delete><fileset dir="${basedir}" includes="**/Question.workflow"/></delete>
      <delete><fileset dir="${basedir}" includes="**/Reply.workflow"/></delete>
      <delete><fileset dir="${basedir}" includes="**/*.connectedApp"/></delete>
      <delete><fileset dir="${basedir}" includes="**/*.dataSource"/></delete>
      <delete><fileset dir="${basedir}" includes="**/*.network"/></delete>
      <delete><fileset dir="${basedir}" includes="**/API_Only.permissionset"/></delete>
      <delete><fileset dir="${basedir}" includes="**/CEC_Delegated_Administrators.permissionset"/></delete>
      <delete><fileset dir="${basedir}" includes="**/CEC_Automated_User.permissionset"/></delete>
      <delete><fileset dir="${basedir}" includes="**/***HELP***.homePageComponent"/></delete>
      <antcall target="generatePackage"/>
    </target>     

</project>
