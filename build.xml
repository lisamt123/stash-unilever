<project name="salesforce" default="validate" basedir="." xmlns:sf="antlib:com.salesforce">

    <taskdef uri="antlib:com.salesforce"
        resource="com/salesforce/antlib.xml"
        classpath="${basedir}/lib/ant-salesforce.jar"/>

    <property file="${basedir}/build.properties"/>
    <property environment="env"/>

    <import file="${basedir}/lib/exec_anon.xml"/>
    <import file="${basedir}/lib/deploy.xml"/>
    <import file="${basedir}/lib/undeploy.xml"/>
    <import file="${basedir}/lib/run_tests.xml"/>
    <import file="${basedir}/lib/package_generator.xml"/>    

    <target name="retrieve" description="Recreate the deployment directory and retrieve all metadata from your org">
        <echo level="info">Performing a retrieve</echo>     
        <mkdir dir="${basedir}/${sfdc.retrieveTarget}"/>
        <sf:retrieve username="${sf.username}"
                     password="${sf.password}"
                     serverurl="${sf.serverurl}"
                     retrieveTarget="${basedir}/${sfdc.retrieveTarget}"
                     unpackaged="src/package.xml"
                     pollWaitMillis="${sfdc.pollWaitMillis}"
                     maxPoll="${sfdc.maxPoll}"/>
        <delete includeemptydirs="true">
            <fileset dir="src" includes="**/*"/>
        </delete>                     
        <move file="${basedir}/${sfdc.retrieveTarget}" tofile="src"/>
    </target>

    <target name="deploy"> 
      <echo level="info">Performing the deploy</echo>     
      <sf:deploy username="${sf.username}" 
        password="${sf.password}" 
        serverurl="${sf.serverurl}" 
        runAllTests="true"
        testLevel="RunLocalTests"
        logType="Detail"
        allowMissingFiles="true"
        autoUpdatePackage="true"
        ignoreWarnings="true"
        deployRoot="${basedir}/src"
        pollWaitMillis="${sfdc.pollWaitMillis}"
        maxPoll="${sfdc.maxPoll}"/>
    </target>

    <target name="validate">
      <echo level="info">Testing the deployment</echo>
      <sf:deploy username="${sf.username}" 
        password="${sf.password}" 
        serverurl="${sf.serverurl}" 
        checkOnly="true"
        runAllTests="true"
        logType="Debugonly"
        testLevel="RunLocalTests"
        allowMissingFiles="true"
        autoUpdatePackage="true"
        ignoreWarnings="true"
        deployRoot="src"
        pollWaitMillis="${sfdc.pollWaitMillis}"
        maxPoll="${sfdc.maxPoll}"/>
    </target>
	
	
    <target name="validateBET">
      <echo level="info">Testing the deployment of BET</echo>
      <sf:deploy username="${sf.username}" 
        password="${sf.password}" 
        serverurl="${sf.serverurl}" 
        checkOnly="true"
        logType="Debugonly"
        testLevel="RunSpecifiedTests"
        allowMissingFiles="true"
        autoUpdatePackage="true"
        ignoreWarnings="true"
        deployRoot="src"
        pollWaitMillis="${sfdc.pollWaitMillis}"
        maxPoll="${sfdc.maxPoll}">
					<runTest>BET_AccessService</runTest>
					<runTest>BET_AccessServiceTest</runTest>
					<runTest>BET_ApproveProjectsComponentContrTest</runTest>
					<runTest>BET_ApproveProjectsComponentController</runTest>
					<runTest>BET_AssetHandler</runTest>
					<runTest>BET_AssetHandlerCls</runTest>
					<runTest>BET_AssetHandlerClsTest</runTest>
					<runTest>BET_AssetService</runTest>
					<runTest>BET_AssetServiceTest</runTest>
					<runTest>BET_BETChangesLogger</runTest>
					<runTest>BET_BETHandler</runTest>
					<runTest>BET_BETHandlerCls</runTest>
					<runTest>BET_BETHandlerClsHelper</runTest>
					<runTest>BET_BETService</runTest>
					<runTest>BET_BETServiceTest</runTest>
					<runTest>BET_BETWrapper</runTest>
					<runTest>BET_BatchAssetStatusMapping</runTest>
					<runTest>BET_BatchAssetStatusMapping_Test</runTest>
					<runTest>BET_BatchBETStatusMapping</runTest>
					<runTest>BET_BatchBETStatusMapping_Test</runTest>
					<runTest>BET_BatchBrandDelete</runTest>
					<runTest>BET_BatchBrandDelete_Test</runTest>
					<runTest>BET_BatchBrandMapping</runTest>
					<runTest>BET_BatchBrandMapping_Test</runTest>
					<runTest>BET_BatchCategoryMapping</runTest>
					<runTest>BET_BatchCategoryMapping_Test</runTest>
					<runTest>BET_BatchCopyBrandValues</runTest>
					<runTest>BET_BatchCopyBrandValues_Test</runTest>
					<runTest>BET_BatchDeniedMemberRequestDelete</runTest>
					<runTest>BET_BatchDeniedMemberRequestDelete_Test</runTest>
					<runTest>BET_BatchMediaChannel1Mapping</runTest>
					<runTest>BET_BatchMediaChannel1Mapping_Test</runTest>
					<runTest>BET_BatchOldAssetStatusMapping</runTest>
					<runTest>BET_BatchOldAssetStatusMapping_Test</runTest>
					<runTest>BET_BatchScheduler</runTest>
					<runTest>BET_BatchScheduler_Test</runTest>
					<runTest>BET_BatchUpdateChatterGroupInfo</runTest>
					<runTest>BET_BatchUpdateChatterGroupInfo_Test</runTest>
					<runTest>BET_CategoryBrandSelectionController</runTest>
					<runTest>BET_CategoryBrandSelectionControllerTest</runTest>
					<runTest>BET_CategoryComponentData</runTest>
					<runTest>BET_ChatterController</runTest>
					<runTest>BET_ChatterController_Test</runTest>
					<runTest>BET_ChatterGroupAutoArchDis_BatchTest</runTest>
					<runTest>BET_ChatterGroupAutoArchiveDisable_Batch</runTest>
					<runTest>BET_CommonService</runTest>
					<runTest>BET_CommonServiceTest</runTest>
					<runTest>BET_CustomBETException</runTest>
					<runTest>BET_DataFixReleaseDate_Batch</runTest>
					<runTest>BET_DataFixReleaseDate_BatchTest</runTest>
					<runTest>BET_EditAssetController</runTest>
					<runTest>BET_EditAssetController_Test</runTest>
					<runTest>BET_EmailNotificationService</runTest>
					<runTest>BET_EmailNotificationServiceTest</runTest>
					<runTest>BET_ExpectedAssetsController</runTest>
					<runTest>BET_ExpectedAssetsControllerTest</runTest>
					<runTest>BET_FollowRequestTriggerHandler</runTest>
					<runTest>BET_FollowRequestTriggerHandlerCls</runTest>
					<runTest>BET_FollowRequestTriggerHandlerClsHelper</runTest>
					<runTest>BET_FollowRequestTriggerHandlerClsTest</runTest>
					<runTest>BET_InoplanToIPMMigration_Batch</runTest>
					<runTest>BET_InoplanToIPMMigration_Batch_Test</runTest>
					<runTest>BET_LinkedProjectsComponentContrTest</runTest>
					<runTest>BET_LinkedProjectsComponentController</runTest>
					<runTest>BET_LinkingService</runTest>
					<runTest>BET_LinkingServiceHelper</runTest>
					<runTest>BET_LinkingServiceHelperTest</runTest>
					<runTest>BET_LinkingServiceTest</runTest>
					<runTest>BET_MDODataMigrationAndTransform_Batch</runTest>
					<runTest>BET_ManagerunTestController</runTest>
					<runTest>BET_ManagerunTestController_Test</runTest>
					<runTest>BET_ManagerunTestController_Test2</runTest>
					<runTest>BET_ManagerunTestController_Test3</runTest>
					<runTest>BET_MasterDataService</runTest>
					<runTest>BET_MasterDataServiceTest</runTest>
					<runTest>BET_MemberBucketWrapper</runTest>
					<runTest>BET_MemberRequestHandlerCls</runTest>
					<runTest>BET_MemberRequestHandlerClsTest</runTest>
					<runTest>BET_Member_RequestHandler</runTest>
					<runTest>BET_NewBetComponentController</runTest>
					<runTest>BET_NewBetComponentControllerTest</runTest>
					<runTest>BET_NewBetController</runTest>
					<runTest>BET_NewBetControllerTest</runTest>
					<runTest>BET_PresentationBatch</runTest>
					<runTest>BET_PresentationBatch_Test</runTest>
					<runTest>BET_ReleaseDateEmails</runTest>
					<runTest>BET_ReleaseDateEmails_Test</runTest>
					<runTest>BET_SCH_BatchDeniedMemberRequestDel_Test</runTest>
					<runTest>BET_SCH_BatchDeniedMemberRequestDelete</runTest>
					<runTest>BET_SoslFieldsBatch</runTest>
					<runTest>BET_SoslFieldsBatch_Test</runTest>
					<runTest>BET_SuggestrunTestController</runTest>
					<runTest>BET_SuggestrunTestControllerTest</runTest>
					<runTest>BET_SuggestedrunTestervice</runTest>
					<runTest>BET_SuggestedrunTesterviceTest</runTest>
					<runTest>BET_Team_MemberHandler</runTest>
					<runTest>BET_Team_MemberHandlerCls</runTest>
					<runTest>BET_Team_MemberHandlerClsHelper</runTest>
					<runTest>BET_Team_MemberHandlerClsHelperTest</runTest>
					<runTest>BET_Team_MemberHandlerClsTest</runTest>
					<runTest>BET_TestUtils</runTest>
					<runTest>BET_TestingHelper</runTest>
					<runTest>BET_TriggerFactory</runTest>
					<runTest>BET_TriggerFactory</runTest>
					<runTest>BET_Triggers_Test</runTest>
					<runTest>BET_UpdateBETSearchHandler</runTest>
					<runTest>BET_UpsertBETController</runTest>
					<runTest>BET_UpsertBETControllerTest</runTest><runTest>BET_AccessService</runTest>
					<runTest>BET_AccessServiceTest</runTest>
					<runTest>BET_ApproveProjectsComponentContrTest</runTest>
					<runTest>BET_ApproveProjectsComponentController</runTest>
					<runTest>BET_AssetHandler</runTest>
					<runTest>BET_AssetHandlerCls</runTest>
					<runTest>BET_AssetHandlerClsTest</runTest>
					<runTest>BET_AssetService</runTest>
					<runTest>BET_AssetServiceTest</runTest>
					<runTest>BET_BETChangesLogger</runTest>
					<runTest>BET_BETHandler</runTest>
					<runTest>BET_BETHandlerCls</runTest>
					<runTest>BET_BETHandlerClsHelper</runTest>
					<runTest>BET_BETService</runTest>
					<runTest>BET_BETServiceTest</runTest>
					<runTest>BET_BETWrapper</runTest>
					<runTest>BET_BatchAssetStatusMapping</runTest>
					<runTest>BET_BatchAssetStatusMapping_Test</runTest>
					<runTest>BET_BatchBETStatusMapping</runTest>
					<runTest>BET_BatchBETStatusMapping_Test</runTest>
					<runTest>BET_BatchBrandDelete</runTest>
					<runTest>BET_BatchBrandDelete_Test</runTest>
					<runTest>BET_BatchBrandMapping</runTest>
					<runTest>BET_BatchBrandMapping_Test</runTest>
					<runTest>BET_BatchCategoryMapping</runTest>
					<runTest>BET_BatchCategoryMapping_Test</runTest>
					<runTest>BET_BatchCopyBrandValues</runTest>
					<runTest>BET_BatchCopyBrandValues_Test</runTest>
					<runTest>BET_BatchDeniedMemberRequestDelete</runTest>
					<runTest>BET_BatchDeniedMemberRequestDelete_Test</runTest>
					<runTest>BET_BatchMediaChannel1Mapping</runTest>
					<runTest>BET_BatchMediaChannel1Mapping_Test</runTest>
					<runTest>BET_BatchOldAssetStatusMapping</runTest>
					<runTest>BET_BatchOldAssetStatusMapping_Test</runTest>
					<runTest>BET_BatchScheduler</runTest>
					<runTest>BET_BatchScheduler_Test</runTest>
					<runTest>BET_BatchUpdateChatterGroupInfo</runTest>
					<runTest>BET_BatchUpdateChatterGroupInfo_Test</runTest>
					<runTest>BET_CategoryBrandSelectionController</runTest>
					<runTest>BET_CategoryBrandSelectionControllerTest</runTest>
					<runTest>BET_CategoryComponentData</runTest>
					<runTest>BET_ChatterController</runTest>
					<runTest>BET_ChatterController_Test</runTest>
					<runTest>BET_ChatterGroupAutoArchDis_BatchTest</runTest>
					<runTest>BET_ChatterGroupAutoArchiveDisable_Batch</runTest>
					<runTest>BET_CommonService</runTest>
					<runTest>BET_CommonServiceTest</runTest>
					<runTest>BET_CustomBETException</runTest>
					<runTest>BET_DataFixReleaseDate_Batch</runTest>
					<runTest>BET_DataFixReleaseDate_BatchTest</runTest>
					<runTest>BET_EditAssetController</runTest>
					<runTest>BET_EditAssetController_Test</runTest>
					<runTest>BET_EmailNotificationService</runTest>
					<runTest>BET_EmailNotificationServiceTest</runTest>
					<runTest>BET_ExpectedAssetsController</runTest>
					<runTest>BET_ExpectedAssetsControllerTest</runTest>
					<runTest>BET_FollowRequestTriggerHandler</runTest>
					<runTest>BET_FollowRequestTriggerHandlerCls</runTest>
					<runTest>BET_FollowRequestTriggerHandlerClsHelper</runTest>
					<runTest>BET_FollowRequestTriggerHandlerClsTest</runTest>
					<runTest>BET_InoplanToIPMMigration_Batch</runTest>
					<runTest>BET_InoplanToIPMMigration_Batch_Test</runTest>
					<runTest>BET_LinkedProjectsComponentContrTest</runTest>
					<runTest>BET_LinkedProjectsComponentController</runTest>
					<runTest>BET_LinkingService</runTest>
					<runTest>BET_LinkingServiceHelper</runTest>
					<runTest>BET_LinkingServiceHelperTest</runTest>
					<runTest>BET_LinkingServiceTest</runTest>
					<runTest>BET_MDODataMigrationAndTransform_Batch</runTest>
					<runTest>BET_ManagerunTestController</runTest>
					<runTest>BET_ManagerunTestController_Test</runTest>
					<runTest>BET_ManagerunTestController_Test2</runTest>
					<runTest>BET_ManagerunTestController_Test3</runTest>
					<runTest>BET_MasterDataService</runTest>
					<runTest>BET_MasterDataServiceTest</runTest>
					<runTest>BET_MemberBucketWrapper</runTest>
					<runTest>BET_MemberRequestHandlerCls</runTest>
					<runTest>BET_MemberRequestHandlerClsTest</runTest>
					<runTest>BET_Member_RequestHandler</runTest>
					<runTest>BET_NewBetComponentController</runTest>
					<runTest>BET_NewBetComponentControllerTest</runTest>
					<runTest>BET_NewBetController</runTest>
					<runTest>BET_NewBetControllerTest</runTest>
					<runTest>BET_PresentationBatch</runTest>
					<runTest>BET_PresentationBatch_Test</runTest>
					<runTest>BET_ReleaseDateEmails</runTest>
					<runTest>BET_ReleaseDateEmails_Test</runTest>
					<runTest>BET_SCH_BatchDeniedMemberRequestDel_Test</runTest>
					<runTest>BET_SCH_BatchDeniedMemberRequestDelete</runTest>
					<runTest>BET_SoslFieldsBatch</runTest>
					<runTest>BET_SoslFieldsBatch_Test</runTest>
					<runTest>BET_SuggestrunTestController</runTest>
					<runTest>BET_SuggestrunTestControllerTest</runTest>
					<runTest>BET_SuggestedrunTestervice</runTest>
					<runTest>BET_SuggestedrunTesterviceTest</runTest>
					<runTest>BET_Team_MemberHandler</runTest>
					<runTest>BET_Team_MemberHandlerCls</runTest>
					<runTest>BET_Team_MemberHandlerClsHelper</runTest>
					<runTest>BET_Team_MemberHandlerClsHelperTest</runTest>
					<runTest>BET_Team_MemberHandlerClsTest</runTest>
					<runTest>BET_TestUtils</runTest>
					<runTest>BET_TestingHelper</runTest>
					<runTest>BET_TriggerFactory</runTest>
					<runTest>BET_TriggerFactory</runTest>
					<runTest>BET_Triggers_Test</runTest>
					<runTest>BET_UpdateBETSearchHandler</runTest>
					<runTest>BET_UpsertBETController</runTest>
					<runTest>BET_UpsertBETControllerTest</runTest>					
		</sf:deploy>
    </target>

    <target name="deployRunAllTests"> 
      <echo level="info">Performing the tests and deploy</echo>     
      <sf:deploy username="${sf.username}" 
        password="${sf.password}" 
        serverurl="${sf.serverurl}" 
        runAllTests="false"
        logType="Detail"
        allowMissingFiles="true"
        autoUpdatePackage="true"
        ignoreWarnings="true"
        deployRoot="${basedir}/src"
        pollWaitMillis="${sfdc.pollWaitMillis}"
        maxPoll="${sfdc.maxPoll}"/>
    </target>  

    <target name="validate-undeploy">
      <echo level="info">Performing validate undeploy - DESTRUCTIVE CHANGE</echo>  
      <sf:deploy username="${sf.username}" 
        password="${sf.password}" 
        serverurl="${sf.serverurl}" 
        checkOnly="true"
        runAllTests="true"
        logType="Debugonly"
        testLevel="RunLocalTests"
        allowMissingFiles="true"
        autoUpdatePackage="true"
        ignoreWarnings="true"       
        deployRoot="${basedir}/undeploy"
        pollWaitMillis="${sfdc.pollWaitMillis}"
        maxPoll="${sfdc.maxPoll}"/>        
    </target>

    <target name="undeploy">
      <echo level="info">Performing undeploy - DESTRUCTIVE CHANGE</echo>  
      <sf:deploy username="${sf.username}" 
        password="${sf.password}" 
        serverurl="${sf.serverurl}" 
        checkOnly="false"
        runAllTests="true"
        logType="Debugonly"
        testLevel="RunLocalTests"
        allowMissingFiles="true"
        autoUpdatePackage="true"
        ignoreWarnings="true"       
        deployRoot="${basedir}/undeploy"
        pollWaitMillis="${sfdc.pollWaitMillis}"
        maxPoll="${sfdc.maxPoll}"/>        
    </target>

    <target name="sandbox-setup" depends="enable-deploy-user">
      <echo level="info">CI Sandbox setup scripts to allow data dependent tests to pass</echo>   
      <antcall target="ExecAnonScript">
        <param name="what" value="${basedir}/scripts/sandbox-setup.apex" />
        <param name="username" value="${sf.username}" />
        <param name="password" value="${sf.password}" />
        <param name="serverurl" value="${sf.serverurl}"/>
      </antcall>
    </target>    
    
    <target name="enable-deploy-user">
      <echo level="info">Enable CI deploy user which is used to run unit tests</echo>   
      <antcall target="ExecAnonScript">
        <param name="what" value="${basedir}/scripts/enable-deploy-user.apex" />
        <param name="username" value="${sf.username}" />
        <param name="password" value="${sf.password}" />
        <param name="host" value="${sf.serverurl}"/>
      </antcall>
    </target> 

</project>
