<apex:page showHeader="false" sidebar="false" docType="html-5.0" controller="Oblix_SOWCampaignCreateController" standardStylesheets="true">
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/s/bs-3.3.5/jqc-1.11.3,dt-1.10.10/datatables.min.css" />
    <script type="text/javascript" src="https://cdn.datatables.net/s/bs-3.3.5/jqc-1.11.3,dt-1.10.10/datatables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.Oblix_SwopAssets, 'Oblix_SwopAssets/css/unilever-style.css')}" />
    <script src="{!URLFOR($Resource.Oblix_JQueryBlockUI)}"></script>
    <script src="{!URLFOR($Resource.Oblix_SwopAssets, 'Oblix_SwopAssets/js/swopJS.js')}" />
    <script>
       $(function (){
                if(window.location.search.indexOf('&') > -1){
                    if(window.location.search.split('&')[1].split('=')[0] === 'assetId'){
                        openAsset()
                    }                      
                }
            });
       
        function setMendatory(x) {

            if (x.parent().parent().find("span").find("select").val() == '') {
                alert('Asset name can\'t be null');
                return false;
            }
            console.dir('parent of parent : ' + x.parent().parent().find(".trDescribe").find(".descMend").val());
            if (x.parent().parent().find("span").find("select").val() == 'Other' && x.parent().parent().find(".trDescribe").find(".descMend").val() == '') {
                x.find(".error").css("display", "block");
                alert('Please give description ');
                return false;
            } else {
                return true;
            }
        }

        function showhideDetail(x) {
            if (x.val() == 'Other') {
                x.parent().parent().find(".trDescribe").removeAttr("style");
            } else {
                x.parent().parent().find(".trDescribe").css("display", "none");
            }
            return false;
        }

        var updateAsset = function(btn) {
            blockme();
            var button = $(btn);
            var assetId = button.attr('data-asset-id');
            var inputDate = $('#dialogMoreDetails table tr:first()').next().find('input').val();
            var date = inputDate.split('-').reverse().toString().replace(new RegExp(',', 'g'), '-');
            var details = {
                quantity: button.siblings('input[type="text"]').val(),
                location: button.closest('tbody').children().first().next().find('input').val(),
                asset_Picklist: button.closest('tbody').children().first().find('input').val() //,
                    //actual_Delivery_Date: date,
                    //additional_Description: $('#dialogMoreDetails table tr:last()').find('textarea').val()
            }

            Oblix_SOWCampaignCreateController.UpdateProjectAction(assetId, details, function(data, event) {
                button.addClass('hide_button');
                button.siblings('input[type="submit"]').removeClass('hide_button');
                refreshAsset();
                //$('#dialogMoreDetails table tr:first()').next().find('input').val('');
                //$('#dialogMoreDetails table tr:last()').find('textarea').val('');
            });
        }
        var removeAsset = function(assetName, projectId) {
            blockme();
            Oblix_SOWCampaignCreateController.removeAsset(assetName, projectId, function(data, event) {
                if (event.status) {
                    refreshAsset();
                }
            });
        };
        
       var getAssetDetails = function (assetId){
            var deferred = $.Deferred();
             Oblix_SOWCampaignCreateController.getAssetDetails(assetId, function (assetDetails, event) {
                 deferred.resolve({data: assetDetails, status: event});
             });
                return deferred.promise();
              }
              
              
              
           var openAsset = function (){
                var assetId = window.location.search.split('&')[1].split('=')[1];
                var assetDetails = getAssetDetails(assetId);
                assetDetails.then(function (data){
                    if(data.status.status){
                        var assetName = data.data.assetTitle;
                  var properties = assetName.split(' X ');
                  var numberOfQuantity = properties[0];
                  var selectedAbreviation = properties[1].split('-');
                  var allAbreviation = JSON.parse(sessionStorage.getItem('assestAbreviations'));                
                  var firstOption = null;
                  var secondOption = null;
                  var thirdOption = selectedAbreviation[2];
                   console.dir('## selectedAbreviation[2] : '+selectedAbreviation[2]);
                  var firstElement = null;
                  var secondElement = null;
                  var thirdElement = null;
                  var selectorDetailPanel = null;
                  var options = null;
                  Object.keys(allAbreviation).forEach(function (key){
                    var currentAbraviation = allAbreviation[key];
                    if(currentAbraviation === selectedAbreviation[0] + '-' + selectedAbreviation[1]){
                      options = key.split('_');
                      console.dir('## opt '+options);
                    }
                  })
                  firstOption = options[0];
                  secondOption = options[1];    
                  console.dir('## firstOption  '+firstOption);
                                     
                  $('.panel-group').find('.panel-default').find('.panel-heading').each(function (index, el){
                  
                    if($(el).text().search(firstOption) !== -1 ){
                      firstElement = $(el);
                      console.dir('### first elmnt une seul fois :'+firstElement.html());
                      var secondSearchArray = firstElement.next().first().find('div[id*="_tabs"]').children('ul');
                      console.dir('### secondSearchArray :'+secondSearchArray.html());
                      secondSearchArray.find('a').each(function (index2, el) {
                          if($(el).text().search(secondOption) !== -1){
                            secondElement = $(el);
                            console.dir('### index :'+index);
                            console.dir('### el :'+el);
                            console.dir('### secondElement :'+secondElement.text());
                            var curentIndex = index + 1;
                            var selector1 = 'div[id*="_tabs-' + curentIndex + '"]';
                            var selector2 = 'a[href*="_tabs-' + curentIndex + thirdOption.replace(/^0+/, '') + '"]';
                            console.dir('### selector1 :'+selector1);
                            console.dir('### selector2 :'+selector2);
                            thirdElement = secondSearchArray.find(selector2);
                            selectorDetailPanel = 'div[id*="_tabs-' + curentIndex + thirdOption.replace(/^0+/, '') + '"]';
                            console.dir('### draft:'+secondSearchArray.find(selector2));
                          }
                      });
                    }
                  });
                  
                  if(firstElement && ! firstElement.parent().find('.panel-collapse').hasClass('in')) firstElement.parent().find('.panel-collapse').addClass('in');
                  if(secondElement && secondElement.find('a').attr('tabindex') !== '0') secondElement.trigger('click');
                  thirdElement.parent().parent().addClass('active');   
                  console.dir('###parent of parent of third elt : '+ thirdElement.parent().html()); 
                  console.dir('## thirdElement '+thirdElement.html());
                  var detailPanel = thirdElement.closest('ul').siblings(selectorDetailPanel);
                  console.dir('## third closest'+ thirdElement.closest('ul').html());    
                            
                  console.dir('## detailPanel '+ detailPanel.html());                  
                  detailPanel.find('tab-pane').find('span select').val(data.data.assetName);
                  detailPanel.find('tab-pane').find('input').val(data.data.location);
                  detailPanel.find('tab-pane').find('input[type="text"]').val(data.data.quantity);
                  
                  console.dir('## firstElement  '+firstElement.find('.panel-collapse').html());
                  
                  
                  
                  if(thirdElement && !thirdElement.parent().hasClass('active')) {
                    detailPanel.find('tr').first().next().next().find('input[type="submit"]').each(function(index, el) {
                      var button = $(el);
                      if(button.val() === 'Update'){
                        button.removeClass('hide_button')
                        .attr('data-asset-id', assetId)
                      } else {
                        button.addClass('hide_button');
                      }
                    });
                    thirdElement.trigger('click');

                  }
                    }
                }, function (err){
                console.log(err);
              });
                  
              }   
      
         var getAbreviationForCardAssets = function (){
                Oblix_SOWCampaignCreateController.getAbreViationByRTBySubCatgForCardAssets(function (data, event){
                  if(event.status){
                    sessionStorage.setItem('assestAbreviations', JSON.stringify(data));
                  }
                });
              }      
        getAbreviationForCardAssets();
    </script>
    <style>
        .removeAssetCss {
            background-image: url("{!URLFOR($Resource.Oblix_SwopAssets, 'Oblix_SwopAssets/images/redcross.png')}") !important;
            background-size: 12px 12px !important;
            background-repeat: no-repeat !important;
        }
        .removeAssetCss:hover {
            background-image: url("{!URLFOR($Resource.Oblix_SwopAssets, 'Oblix_SwopAssets/images/redcross.png')}") !important;
            background-size: 12px 12px !important;
            background-repeat: no-repeat !important;
        }
        .error {
            display: none;
        }
    </style>
    <apex:form >

        <div class="Oblix_header_bkgd">
            <header class="Oblix_header_panel">
                <img src="{!URLFOR($Resource.Oblix_SwopAssets, 'Oblix_SwopAssets/images/Oblix_Unilever_logo.png')}" width="54" height="60" />
                <div class="header_divider_vertical"></div>
                <div class="header_panel_text">
                    <h2>Hi {!userConnected.Name}, Welcome to SWOP the Scope of Work Online Planner</h2>
                    <p><a href="/apex/oblix_sowmain">SWOP Home</a>&nbsp;<span>&#9658;</span>&nbsp;<a href="#">SOW name</a>&nbsp;<span>&#9658;</span>&nbsp;<a href="#">Add new campaign</a>
                    </p>
                </div>
                <button type="button" class="btn btn-xs pull-right btn_cross btn_exit_swop">DONE FOR TODAY? EXIT SWOP
                </button>

            </header>
        </div>
        <div class="container SOW_body">
            <div class="row">
                <div class="col-lg-6">
                    <h1 class="SOW_header_title">{!project.Name} Added!</h1>
                    <p class="SOW_body_option_links"><a href="">View all campaign details</a>
                    </p>
                </div>
                <apex:outputPanel id="campaignFeeId">
                    <table class="SOW_header_value_summary">
                        <tr>
                            <td class="SOW_header_value_title">{!$ObjectType.Oblix_SOW_Projects__c.fields.Campaign_Fees_Total__c.label}</td>
                            <td class="SOW_header_value">
                                <h2>
                               €
                               <apex:outputText value="{0, number,###,###,##0}">
                                 <apex:param value="{!project.Campaign_Fees_Total__c}"/>
                               </apex:outputText>
                                
                            </h2>
                            </td>
                        </tr>
                        <tr>
                            <td class="SOW_header_value_subtitle"> {!$ObjectType.Oblix_SOW_Projects__c.fields.Value_to_be_paid_in_Current_FY__c.label} </td>
                            <td class="SOW_header_value_subvalue">
                                €
                                <apex:outputText value="{0, number,###,###,##0}">
                                    <apex:param value="{!project.Value_to_be_paid_in_Current_FY__c}" />
                                </apex:outputText>
                            </td>
                        </tr>
                    </table>
                </apex:outputPanel>
            </div>
            <hr class="divider" />
            <div class="row confirm_assets_welcome_message">
                <div>
                    <img src="{!URLFOR($Resource.Oblix_SwopAssets, 'Oblix_SwopAssets/images/arrow-blue-down-left.png')}" width="96" height="77" />
                    <h1>{!project.Name} was successfully created.<br/>Select assets from below to add them to your campaign basket.</h1>
                    <img src="{!URLFOR($Resource.Oblix_SwopAssets, 'Oblix_SwopAssets/images/arrow-green-down-right.png')}" width="96" height="77" />
                </div>
            </div>
            <div class="row">
                <div class="col-lg-9 confirm_assets_accordion">
                    <div class="panel-group" id="accordion" role="tablist" aria-multiselectable="true">
                        <apex:variable var="accordianCounter" value="{!1}" />
                        <apex:repeat value="{!lstRecordType}" var="recordType">
                            <div class="panel panel-default">
                                <div class="panel-heading" role="tab" id="heading{!accordianCounter}">
                                    <h4 class="panel-title">
                                    <a role="button" data-toggle="collapse" data-parent="#accordion" href="#collapse{!accordianCounter}" aria-expanded="{!if(accordianCounter == 1,'true','false')}" aria-controls="collapse{!accordianCounter}"><apex:outputText value="{!recordType}" styleClass="recordTypeValue" /> {!mapRecordTypeDescription[recordType]}<img src="{!URLFOR($Resource.Oblix_SwopAssets, 'Oblix_SwopAssets/images/plus.png')}" width="14" height="14" class="pull-right"/></a>
                                </h4>
                                </div>
                                <div id="collapse{!accordianCounter}" class="panel-collapse collapse" role="tabpanel" aria-labelledby="heading{!accordianCounter}">
                                    <div class="panel-body" id="{!mapRTIdCSS[recordType]}_tabs">
                                        <ul class="nav nav-tabs assets_tab_background" data-tabs="tabs">
                                            <apex:variable var="count" value="{!1}" />
                                            <apex:repeat value="{!mapRTSUBCat[recordType]}" var="subCat">
                                                
                                                <li class="{!if(count == 1,'active','')}">
                                                    <a href="#{!mapRTIdCSS[recordType]}_tabs-{!count}" data-toggle="tab">{!subCat}</a>
                                                </li>
                                                <apex:variable var="count" value="{!count + 1}" />
                                            </apex:repeat>
                                           
                                        </ul>
                                        <!-- tab body-->

                                        <div id="my-tab-content" class="tab-content">
                                            <apex:variable var="count2" value="{!1}" />
                                            <apex:repeat value="{!mapRTSUBCat[recordType]}" var="subCat">
                                                <apex:variable var="selectionCount" value="{!1}" />
                                                <div class="tab-pane asset_accordion_body {!if(count2 == 1,'active','')}" id="{!mapRTIdCSS[recordType]}_tabs-{!count2}">
                                                    <p class="asset_accordion_intro">{!mapSubCategOptionDefinition[subCat]}</p>
                                                    <div class="tabbable">
                                                        <div class="col-lg-6" id="{!mapRTIdCSS[recordType]}_tabs{!count2}">
                                                            <ul class="nav nav-pills nav-stacked">
                                                                <apex:variable var="count_opt" value="{!1}" />
                                                                <apex:repeat value="{!mapSubCategOption[subCat]}" var="opt">
                                                                    <li class="accordion_body_options {!if(count_opt == 1,'active','')}"><a href="#{!mapRTIdCSS[recordType]}_tabs-{!count2}{!opt}" title="Score {!opt}" onclick="if($('.hideOptionAsset').is(':visible')) ReInitializeInstanceAF('{!subCat}');" data-toggle="tab"><strong> {!$Label.Oblix_lbl_UIUX_Option} {!count_opt} : </strong> {!mapSubCategOptionDescription[subCat+opt]}</a> </li>
                                                                    <apex:variable var="count_opt" value="{!count_opt + 1}" />
                                                                </apex:repeat>
                                                            </ul>
                                                            <!--p class="accordion_body_options accordion_body_option_active"><a href="#"><strong>Option 2:</strong>&nbsp;Landing Pages, Page Take-overs.</a>
                                                            </p-->
                                                        </div>
                                                        <div class="col-lg-6">
                                                            <div class="add_asset_panel">
                                                                <div class="row">
                                                                    <div class="tab-content">
                                                                        <apex:repeat value="{!mapSubCategOption[subCat]}" var="opt">

                                                                            <div class="tab-pane {!if(selectionCount == 1,'active','')}" id="{!mapRTIdCSS[recordType]}_tabs-{!count2}{!opt}">

                                                                                <!--div class="row"-->

                                                                                <apex:outputPanel id="assetPart">
                                                                                    <apex:actionRegion >


                                                                                        <h2>Option {!selectionCount} selected</h2>
                                                                                        <!--styleClass="removeBreak"-->
                                                                                        <div class="col-lg-4">
                                                                                            <p class="create_SOW_form_titles asset_panel_titles"></p>
                                                                                            <p class="create_SOW_form_titles asset_panel_titles">{!$ObjectType.Oblix_Project_Assets__c.fields.Asset_Picklist__c.label}*</p>
                                                                                            <p class="create_SOW_form_titles asset_panel_titles">{!$ObjectType.Oblix_Project_Assets__c.fields.Quantity__c.label}*
                                                                                                <br/><span class="form_bracket_text">(Numerics only)</span>
                                                                                            </p>
                                                                                            <p class="create_SOW_form_titles asset_panel_titles">Description
                                                                                                <br/><span class="form_bracket_text">(Optional)</span>
                                                                                            </p>
                                                                                        </div>
                                                                                        <div class="col-lg-6">
                                                                                            <apex:inputField value="{!mapAssetsPerSubCat[subCat].Sub_Category__c}" style="display:none" styleClass="{!subCat}" />
                                                                                            <apex:inputField value="{!mapAssetsPerSubCat[subCat].Asset_Picklist__c}" onchange="showhideDetail($(this))" />
                                                                                            <span class="error">error</span>
                                                                                            <div style="display:none" class="trDescribe">
                                                                                                {!$Label.Oblix_lbl_UIUX_Please_describe} &nbsp;
                                                                                                <apex:inputField styleClass="input_init descMend" value="{!mapAssetsPerSubCat[subCat].Location__c}" />
                                                                                            </div>
                                                                                            <apex:inputField value="{!mapAssetsPerSubCat[subCat].Quantity__c}" styleClass="assetQuantity" />

                                                                                            <apex:inputField style="width:100%;min-height:100px" value="{!assetInstance.Additional_Description__c}" styleClass="assetNotes" />
                                                                                            <apex:commandButton value="ADD" action="{!AddToProjectAction}" onclick="if(setMendatory($(this))) blockme();" oncomplete="$.unblockUI()" reRender="assetPart,campaignFeeId,Oblix_card" styleClass="btn btn-primary btn_plus btn_asset_add">
                                                                                                <apex:param assignTo="{!recordType}" name="recordType" value="{!recordType}" />
                                                                                                <apex:param assignTo="{!subCat}" name="subCat" value="{!subCat}" />
                                                                                                <apex:param assignTo="{!complexity}" name="complexity" value="{!opt}" />
                                                                                            </apex:commandButton>
                                                                                        </div>

                                                                                    </apex:actionRegion>
                                                                                </apex:outputPanel>

                                                                            </div>
                                                                            <!--/div-->
                                                                            <apex:variable var="selectionCount" value="{!selectionCount + 1}" />
                                                                        </apex:repeat>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                                <!--                                    tab body end-->
                                                <!--                                    tab body-->

                                                <apex:variable var="count2" value="{!count2 + 1}" />
                                            </apex:repeat>
                                            <!--apex:variable var="selectionCount" value="{!selectionCount + 1}" /-->
                                        </div>
                                        <!--                                    tab body end-->
                                        <!--                                    panel body end-->
                                    </div>
                                </div>
                            </div>
                            <apex:variable var="accordianCounter" value="{!accordianCounter + 1}" />
                        </apex:repeat>
                    </div>
                </div>
                <div class="col-lg-3 asset_shopping_basket_margin">
                    <apex:outputPanel id="Oblix_card">
                        <div class="asset_shopping_basket">
                            <div class="asset_shopping_basket_title_bar">
                                <h2>Campaign Basket ({!countAssetNumberForCampaign} assets)
                                 
                            </h2>
                            </div>
                            <div class="asset_shopping_basket_body">
                                <div class="asset_shopping_basket_item_title ">

                                    <!--
                                <apex:repeat value="{!lstAssetsForCard}" var="asset">
                                        <div class="Oblix_card_elmt">
                                            <div>
                                               <div class="Oblix_button_table_align">
                                                <apex:commandButton styleClass="removeAssetCss" style="width:12px;height:12px"  onclick="removeAsset('{!asset.Id}'); return false"/> <span>{!asset.Asset_Title__c}</span><!--value="{!$Label.Oblix_lbl_UIUX_Delete}" -->
                                    <!--<apex:commandButton value="{!$Label.Oblix_lbl_UIUX_Edit}" onclick="editAset(this, '{!asset.Id}); return false;"/>-->
                                    <!--<input type="button" value="{!$Label.Oblix_lbl_UIUX_Edit}" onclick="editAsset(this, '{!asset.Id}')" class="btn" />
                                                </div>
                                            </div>
                                        </div>
                                </apex:repeat> 
                                -->


                                    <apex:repeat value="{!lstWrapAssets}" var="wrapAsset">
                                        <div class="Oblix_card_elmt asset_shopping_basket_item">
                                            <div>
                                                <div class="Oblix_button_table_align">
                                                    <apex:commandButton styleClass="removeAssetCss" style="width:12px;height:12px" onclick="removeAsset('{!wrapAsset.assetName}', '{!project.Id}'); return false" /> <span>{!wrapAsset.assetName} ({!wrapAsset.numberAsset} assets)</span>
                                                </div>
                                            </div>
                                        </div>

                                    </apex:repeat>
                                </div>
                            </div>
<!--                             <div class="asset_shopping_basket_total">
                                <div class="row">
                                    <div class="col-lg-8">
                                        <p class="asset_shopping_basket_total_fee_text">{!$ObjectType.Oblix_SOW_Projects__c.fields.Campaign_Fees_Total__c.label}</p>
                                        <p class="asset_shopping_basket_total_FY_text">{!$ObjectType.Oblix_SOW_Projects__c.fields.Value_to_be_paid_in_Current_FY__c.label}</p>
                                    </div>
                                    <div class="col-lg-4">
                                        <h2 class="asset_shopping_basket_total_fee_value">€
                                        <apex:outputText value="{0, number,###,###,##0}">
                                             <apex:param value="{!estimateCost}"/>
                                         </apex:outputText>
                                    
                                    </h2>
                                        <p class="asset_shopping_basket_total_FY_value">€
                                            <apex:outputText value="{0, number,###,###,##0}">
                                                <apex:param value="{!project.Value_to_be_paid_in_Current_FY__c}" />
                                            </apex:outputText>
                                        </p>
                                    </div>
                                </div>
                            </div> -->
                            <div class="asset_shopping_basket_total">
                                <div class="row asset_basket_row">
                                        <p class="asset_shopping_basket_total_fee_text">{!$ObjectType.Oblix_SOW_Projects__c.fields.Campaign_Fees_Total__c.label}</p>
                                        <h2 class="asset_shopping_basket_total_fee_value">€
                                        <apex:outputText value="{0, number,###,###,##0}">
                                             <apex:param value="{!estimateCost}"/>
                                         </apex:outputText></h2>
                                </div>
                                <div class="row asset_basket_row">
                                        <p class="asset_shopping_basket_total_FY_text">{!$ObjectType.Oblix_SOW_Projects__c.fields.Value_to_be_paid_in_Current_FY__c.label}</p>
                                        <p class="asset_shopping_basket_total_FY_value">€
                                            <apex:outputText value="{0, number,###,###,##0}">
                                                <apex:param value="{!project.Value_to_be_paid_in_Current_FY__c}" />
                                            </apex:outputText></p>
                                </div>
                            </div>
                            <div class="asset_shopping_basket_btn">
                                <apex:commandButton styleClass="btn btn-primary btn-xs btn_check btn_finish_basket" value="FINISH WITH BASKET" action="{!finishBasket}"/>
                                <!--button type="button" class="btn btn-primary btn-xs"><img src="{!URLFOR($Resource.Oblix_SwopAssets, 'Oblix_SwopAssets/images/check.png')}" width="12" height="12" />
                                </button-->
                            </div>
                            <apex:actionFunction action="{!refresh}" name="refreshAsset" reRender="assetPart,campaignFeeId,estimateId,Oblix_card" oncomplete="$.unblockUI()" />
                        </div>
                    </apex:outputPanel>
                </div>
            </div>
        </div>
    </apex:form>
</apex:page>