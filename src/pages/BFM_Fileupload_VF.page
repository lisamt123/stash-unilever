<apex:page controller="BFM_Fileupload_CC" sidebar="false" standardStylesheets="false" docType="html-5.0">
    <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js" />
    <apex:includeScript value="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.21/jquery-ui.min.js" />
    <apex:styleSheet value="https://ajax.googleapis.com/ajax/libs/jqueryui/1.8.21/themes/smoothness/jquery-ui.css" />
    
    <style>
        .displayNone { 
        display:none; 
        }
        .displayBlock {
        display:block;
        }
        .ui-autocomplete-loading { 
        
        background-size:15px 15px; 
        }
        .placeHolder {
        font-style: italic;
        }
    </style>
    
    <apex:form >
        <apex:pageMessages id="errormsg"/>
        <apex:pageBlock id="pgblck" mode="edit">   
            <apex:pageBlockSection collapsible="false" title="{!$Label.BFM_File_Type}" columns="2">
                
                <apex:pageBlockSectionItem >
                    <apex:outputLabel value="{!$Label.BFM_Filetype}"/>
                    <apex:actionRegion >
                        <apex:selectList value="{!filetype}" multiselect="false" size="1" id="ftype">
                            <apex:selectOptions value="{!filetypelist}"/>
                            <apex:actionSupport event="onchange" rerender="cnpj"/>
                        </apex:selectList>
                    </apex:actionRegion>
                </apex:pageBlockSectionItem>      
                
                <apex:outputPanel id="cnpj">
                    <apex:pageBlockSection columns="2" rendered="{!IF(filetype== 'POD' || filetype== 'NFS',true,false)}">
                        <apex:outputPanel >
                            <apex:outputLabel value="{!$Label.BFM_Choose_CNPJ}"/>
                            <apex:inputText id="cnpjTextBox" value="{!searchTerm}" styleClass="placeHolder" />
                            <apex:inputHidden id="searchcnpjId" value="{!selectedCnpj}" required="true"/>
                        </apex:outputPanel>
                        
                        <script type="text/javascript">
                        var PLACEHOLDER = 'Search CNPJ Here'; 
                        var movieObjects;
                        var queryTerm;
                        $('[id$=cnpjTextBox]').autocomplete({
                            minLength: 2,
                            source: function(request, response) {
                                queryTerm = request.term;
                                BFM_Fileupload_CC.searchCnpj(request.term, function(result, event){
                                    //alert('Result'+result);
                                    if(event.type == 'exception') {
                                        alert(event.message);
                                    } else {
                                        if(result =="" || result == null) {
                                            alert("Please enter a valid CNJP number");
                                            $('[id$=cnpjTextBox]').val('');
                                            $('[id$=searchcnpjId]').val( '');
                                            // .ui-autocomplete-loading
                                        } else{  
                                            movieObjects = result;
                                            response(movieObjects);
                                        }
                                    }
                                });
                            },
                            focus: function( event, ui ) {
                                $('[id$=cnpjTextBox]').val( ui.item.CNPJ__c );
                                return false;
                            },
                            select: function( event, ui ) {
                                $('[id$=cnpjTextBox]').val( ui.item.CNPJ__c );
                                $('[id$=searchcnpjId]').val( ui.item.CNPJ__c );
                                return false;
                            },
                        }).data( "autocomplete" )._renderItem = function( ul, item ) {
                            var entry = "<a>" + item.CNPJ__c;
                            
                            entry = entry + "</a>";
                            entry = entry.replace(queryTerm, "<b>" + queryTerm + "</b>");
                            return $( "<li></li>" )
                            .data( "item.autocomplete", item )
                            .append( entry )
                            .appendTo( ul );
                        };                     
                        // Add or remove placeholder values
                        $('[id$=cnpjTextBox]').val(PLACEHOLDER);
                        $('[id$=cnpjTextBox]').on("focus",  function(event){
                            $tgt = $(event.target);
                            if($tgt.val() === PLACEHOLDER ){
                                $tgt.val('');
                                $tgt.removeClass('placeHolder');
                            }
                        });
                        $('[id$=cnpjTextBox]').on( "blur",  function(event){
                            $tgt = $(event.target);
                            if($tgt.val() === '' ){
                                $tgt.val(PLACEHOLDER);
                                $tgt.addClass('placeHolder');
                            }
                        });
                        </script>
                    </apex:pageBlockSection>
                </apex:outputPanel>
                
            </apex:pageBlockSection>
            
            <apex:pageBlockSection collapsible="false" title="{!$Label.BFM_Upload_Files}" columns="1">
                <apex:repeat value="{!newAttachments}" var="newAtt">                
                    <apex:pageBlockSectionItem >                      
                        <apex:outputLabel value="{!$Label.BFM_File}"/>                         
                        <apex:inputFile value="{!newAtt.body}" filename="{!newAtt.name}" size="{!newAtt.bodylength}" contentType="{!newAtt.contenttype}" id="fileId"/>                       
                    </apex:pageBlockSectionItem>                
                </apex:repeat>
            </apex:pageBlockSection>
            
            <apex:pageBlockButtons location="bottom">
                <apex:commandButton value="{!$Label.BFM_Upload}" action="{!save}"/>
                <apex:commandButton value="{!$Label.BFM_Cancel}" action="{!cancel}"/>
            </apex:pageBlockButtons>            
        </apex:pageBlock>       
    </apex:form>
    
</apex:page>