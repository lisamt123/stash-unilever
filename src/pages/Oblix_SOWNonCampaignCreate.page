<apex:page sidebar="false" controller="Oblix_SOWNonCampaignCreateController" docType="html-5.0" showHeader="false" standardStylesheets="true">
    <script src="//code.jquery.com/jquery-1.10.2.js"></script>
    <script src="//code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/s/bs-3.3.5/jqc-1.11.3,dt-1.10.10/datatables.min.css" />
    <script type="text/javascript" src="https://cdn.datatables.net/s/bs-3.3.5/jqc-1.11.3,dt-1.10.10/datatables.min.js"></script>
    <link rel="stylesheet" type="text/css" href="{!URLFOR($Resource.Oblix_SwopAssets, 'Oblix_SwopAssets/css/unilever-style.css')}" />
    <script src="{!URLFOR($Resource.Oblix_JQueryBlockUI)}"></script>
    <script src="{!URLFOR($Resource.Oblix_SwopAssets, 'Oblix_SwopAssets/js/swopJS.js')}" />
    <script>
        var key = 0;

        function addToActivitySelection() {
            var nonCampaignItem = {};
            var validationPass;
            nonCampaignItem.selectedCountry = $('[id$="country"] option:selected').text();
            nonCampaignItem.selectedActivity = $('[id$="activityId"] option:selected').text();
            nonCampaignItem.selectedAgencyDepartment = $('[id$="agencyDepartment"] option:selected').text();
            nonCampaignItem.selectedRole = $('[id$="selectedRole"] option:selected').text();
            validationPass = validateSelection();
            if(validationPass){
                key = '{!marketing_SOW.Id}' + nonCampaignItem.selectedActivity + nonCampaignItem.selectedCountry + nonCampaignItem.selectedAgencyDepartment + nonCampaignItem.selectedRole;
                nonCampaignItem.hourlyRate = $('[id$="rate"]').text();
                nonCampaignItem.hoursSelected = $('[id$="hoursSelected"]').val();
                nonCampaignItem.totalAmount = nonCampaignItem.hourlyRate * nonCampaignItem.hoursSelected;
                nonCampaignItem.key = key;
                addToActivitySelectionMap(JSON.stringify(nonCampaignItem));
            }
            return false;
        }

        function validateSelection(){
            if($('[id$="activityId"] option:selected').text() == '--None--'){
                alert('Please choose Activity');
                return false;
            }
            if($('[id$="country"] option:selected').text() == '-Country-'){
                alert('Please choose Country');
                return false;
            }
            if($('[id$="agencyDepartment"] option:selected').text() == '-Agency Department-'){
                alert('Please choose Agency Department');
                return false;
            }
            if($('[id$="selectedRole"] option:selected').text() == '-Role-'){
                alert('Please choose a Role');
                return false;
            }
            if($('[id$="hoursSelected"]').val() == ''){
                alert('Please Enter number of hours required');
                return false;
            }
            return true;
        }

        function validateResourceSelection(){
            if($('[id$="dedicatedResourceName"]').val() == ''){
                alert('Please enter a resource name');
                return false;
            }
            if($('[id$="dedicatedCountry"] option:selected').text() == '-Country-'){
                alert('Please choose Country');
                return false;
            }
            if($('[id$="dedicatedAgencyDepartment"] option:selected').text() == '-Agency Department-'){
                alert('Please choose Agency Department');
                return false;
            }
            if($('[id$="dedicatedSelectedRole"] option:selected').text() == '-Role-'){
                alert('Please choose a Role');
                return false;
            }
            if($('[id$="prcent"]').val() == ''){
                alert('Please Enter % of hours required');
                return false;
            }
            if(true){
                blockme();
                insertSelectedResource();
            }
            return true;
        }

        function removeRow(selectedkey){
            console.log('SelectedKey : ' + selectedkey); 
            var returnValue = confirm("Are you sure you want to Delete?");
            if(selectedkey != null){
                if(returnValue == true){
                    removeFromSelectionMap(selectedkey);
                }else{
                    return returnValue;
                }
            }
        }

        function basketRemoveRow(basketName){
            var returnValue = confirm("Are you sure you want to Delete?");
            if(basketName != null){
                if(returnValue == true){
                    removeItemFromBasketList(basketName);
                }else{
                    return returnValue;
                }
            }
        }

    </script>
    <apex:form >
        <head>
            <title>SWOP : {!marketing_SOW.Name}</title>
        </head>

        <apex:actionFunction action="{!fillAgencyDepartment}" oncomplete="$.unblockUI()" name="adupdate" reRender="agencyDepartment,dedicatedAgencyDepartment,selectedRole,rate,rater,result,add,errMsg,other_pane" >
            <apex:param name="selectedTab" assignTo="{!selectedTab}" value="" />
        </apex:actionFunction>

        <apex:actionFunction action="{!fillRoleTitle}" oncomplete="$.unblockUI()" name="RTupdate" reRender="selectedRole,dedicatedSelectedRole,rate,rater,result,add,errMsg" >
            <apex:param name="selectedTab" assignTo="{!selectedTab}" value="" />
        </apex:actionFunction>

        <apex:actionFunction action="{!fillRate}" oncomplete="$.unblockUI()" name="Rateupdate" reRender="rate,dedicatedRate,rater,hours,result,add,errMsg" >
            <apex:param name="selectedTab" assignTo="{!selectedTab}" value="" />
        </apex:actionFunction>       


        <apex:actionFunction action="{!getAndSetActivitiesByName}" oncomplete="$.unblockUI()" name="getAndSetActivitiesByName" reRender="selectionTable,activity_input_field_panel,resource_input_fields,activity_tabs">
            <apex:param name="campaignItem" assignTo="{!selectedName}" value="" />
        </apex:actionFunction>
        <apex:actionFunction action="{!addToActivitySelectionMap}" oncomplete="$.unblockUI()" name="addToActivitySelectionMap" reRender="selectionTable,activity_input_field_panel">
            <apex:param name="campaignItem" assignTo="{!seletedActivity}" value="" />
            <!-- <apex:param name="is_selection_for_edit_mode" assignTo="{!is_selection_for_edit_mode}" value="false" /> -->
        </apex:actionFunction>
        <apex:actionFunction action="{!removeFromSelectionMap}" oncomplete="$.unblockUI()" name="removeFromSelectionMap" reRender="selectionTable,shoppingBasketPanel,campaignTotalPanel,shoppingBasketPanel,activity_input_field_panel">
            <apex:param name="selectedkey" assignTo="{!selectedkey}" value="" />
            <!-- <apex:param name="is_selection_for_edit_mode" assignTo="{!is_selection_for_edit_mode}" value="false" /> -->
        </apex:actionFunction>
        <apex:actionFunction action="{!removeItemFromBasketList}" oncomplete="$.unblockUI()" name="removeItemFromBasketList" reRender="shoppingBasketPanel,campaignTotalPanel,shoppingBasketPanel">
            <apex:param name="basketItemToRemove" assignTo="{!basketItemToRemove}" value="" />
        </apex:actionFunction>
        <apex:actionFunction action="{!insertSelectedActivitiesAndRefreshBasket}" oncomplete="$.unblockUI()" name="insertSelectedActivities" reRender="shoppingBasketPanel,selectionTable,campaignTotalPanel,shoppingBasketPanel" >
            <!-- <apex:param name="is_selection_for_edit_mode" assignTo="{!is_selection_for_edit_mode}" value="false" /> -->
        </apex:actionFunction>
        <apex:actionFunction action="{!upsertSelectedResourceAndRefreshBasket}" oncomplete="$.unblockUI()" name="insertSelectedResource" reRender="shoppingBasketPanel,selectionTable,campaignTotalPanel,shoppingBasketPanel" />    

        <apex:actionFunction action="{!setActivityInputFieldsForSelectedItem}" oncomplete="$.unblockUI()" name="setActivityInputFieldsForSelectedItem" reRender="activity_input_field_panel">
            <apex:param name="selected_activity" assignTo="{!selected_activity}" value="" />
            <apex:param name="selected_country" assignTo="{!selected_country}"  value=""/>
            <apex:param name="selected_agent_department" assignTo="{!selected_agent_department}"  value=""/>
            <apex:param name="selected_other" assignTo="{!selected_other}" value="" />
            <apex:param name="selected_role" assignTo="{!selected_role}" value="" />
            <apex:param name="selected_hours" assignTo="{!selected_hours}" value="" />
            <apex:param name="selected_hourly_rate" assignTo="{!selected_hourly_rate}" value="" />
            <!-- <apex:param name="is_selection_for_edit_mode" assignTo="{!is_selection_for_edit_mode}" value="true" /> -->
        </apex:actionFunction>

        <div class="Oblix_header_bkgd">
            <header class="Oblix_header_panel">
                <img alt="Unilever logo" src="{!URLFOR($Resource.Oblix_SwopAssets, 'Oblix_SwopAssets/images/Oblix_Unilever_logo.png')}" width="54" height="60" />
                <div class="header_divider_vertical"></div>
                <div class="header_panel_text">
                    <h2>Hi  {!$User.FirstName} {!$User.LastName }, Welcome to SWOP the Scope of Work Online Planner</h2>
                    <p><a href="/apex/oblix_sowmain">SWOP Home</a>&nbsp;<span>&#9658;</span>&nbsp;<a href="/apex/oblix_sowmaindetail?sowId={!marketing_SOW.Id}">{!marketing_SOW.Name}</a>&nbsp;<span>&#9658;</span>&nbsp;Add non-campaign items
                    </p>
                </div>
                <apex:commandButton styleClass="btn btn-xs pull-right btn_cross btn_exit_swop" action="{!exitSwop}" value="DONE FOR TODAY? EXIT SWOP">
                </apex:commandButton>

            </header>
        </div>
        <div class="container SOW_body">
            <div class="row">
                <div class="col-lg-6 col-md-6">
                    <h1 class="SOW_header_title">Add Non-Campaign Items to {!marketing_SOW.Name}</h1>
                </div>
                <apex:outputPanel id="campaignTotalPanel">
                    <table class="SOW_header_value_summary">
                        <tr>
                            <td class="SOW_header_value_title">Non Campaign Estimated Fee</td>
                            
                            <td class="SOW_header_value">
                                <h2>€<apex:outputText value="{0, number,###,###,##0}">
                                        <apex:param value="{!campaignTotalValue}"/>
                                    </apex:outputText>
                                </h2>
                            </td>
                        </tr>
                    </table>
                </apex:outputPanel>
            </div>
            <hr class="divider" />
            <apex:outputPanel id="errMsg">
               <apex:outputPanel rendered="true"  >                          
                    <apex:pagemessages ></apex:pagemessages>
               </apex:outputPanel>   
            </apex:outputPanel>
            <div class="row">
                <div class="col-lg-9">
                    <apex:outputPanel id="activity_tabs">

                    <div class="row">
<!--                         <ul class="sow_tab_style nav nav-tabs sow_tab_align" data-tabs="tabs">
                            <li role="presentation" class="non_camp_tab_line_align {!if(selectedTab<>'dedicated resource','active','')}"><a href="#activity" data-toggle="tab">Add activity</a>
                            </li>
                            <li role="presentation" class="non_camp_tab_line_align {!if(selectedTab=='dedicated resource','active','')}"><a href="#resource" data-toggle="tab">Add dedicated resource</a>
                            </li>
                        </ul> -->
                        <ul class="sow_tab_style nav nav-tabs sow_tab_align" data-tabs="tabs">
                            <li role="presentation" class="non_camp_tab_line_align active"><a href="#activity" data-toggle="tab">Add activity</a>
                            </li>
                            <li role="presentation" class="non_camp_tab_line_align"><a href="#resource" data-toggle="tab">Add dedicated resource</a>
                            </li>
                        </ul>
                    </div>
                    </apex:outputPanel>

                    <div id="my-tab-content" class="tab-content">
                        <div class="tab-pane active" id="activity">
                    <apex:outputPanel id="activity_input_field_panel">

                            <div class="row">
                                <div class="col-lg-4">
                                    <p class="create_SOW_form_titles">Activity*</p>
                                    <apex:inputField value="{!activity.nonCampaignItem.Activities__c}" styleclass="investment_project_dropdowns_right" id="activityId" onchange="adupdate('activity');blockme();" />
                                    <!-- <apex:inputField value="{!activity.nonCampaignItem.Activities__c}" styleclass="investment_project_dropdowns_right" id="activityId" onchange="if ($(this).val()=='Other'){ $('.otherr').prop('disabled', false);}else{ $('.otherr').prop('disabled', true);}" /> -->
                                </div>
                                <div class="col-lg-4">
                                    <p class="create_SOW_form_titles">Country*</p>
                                    <apex:selectList size="1" value="{!activity.selectedCountryname}" onchange="adupdate('activity');blockme();" styleclass="investment_project_dropdowns_right" id="country">
                                        <apex:selectOptions value="{!countries}" />
                                    </apex:selectList>
                                </div>
                                <div class="col-lg-4">
                                    <p class="create_SOW_form_titles">Agency department*</p>
                                    <apex:selectList size="1" value="{!activity.selectedAgencyDepartment}" styleclass="picklist_init" id="agencyDepartment" onchange="RTupdate('activity');blockme();" disabled="{!IF(activity.agencyVisible==false,true,false)}" style="min-width:100%;">
                                        <apex:selectOptions value="{!AgencyDepartments}" />
                                    </apex:selectList>
                                </div>
                            </div>
                            <apex:outputPanel id="other_pane" rendered="{!if(activity.nonCampaignItem.Activities__c == 'Other',true,false)}">
                                <div class="row">
                                    <div class="col-lg-4">
                                        <p class="non_campaign_other">Please describe "other"</p>
                                        <apex:inputField styleClass="resource_name_box_align" value="{!activity.nonCampaignItem.name}" id="dedicatedResourceOther"  />
                                    </div>
                                </div>
                            </apex:outputPanel>
                            <div class="row">
                                <div class="col-lg-4 non_camp_dropdown_spacing">
                                    <p class="create_SOW_form_titles">Role*</p>
                                    <apex:selectList size="1" value="{!activity.selectedRole}" id="selectedRole" styleclass="picklist_init" style="min-width:100%;" disabled="{!IF(activity.roleVisible==false,true,false)}" onchange="Rateupdate('activity');blockme();">
                                        <apex:selectOptions value="{!agencyRoleTitle}" />
                                    </apex:selectList>
                                </div>
                                <div class="col-lg-8 non-campaign_hourly_rate_section">
                                    <p>Hourly rate €
                                        <apex:outputLabel value="{!activity.hourlyRate}" id="rate" />
                                        <apex:input type="number" styleClass="hourly_rate_box" html-min="0" value="{!activity.hoursSelected}" onchange="if(!isNaN(parseInt($('.rateclass').text()))){ $('.rslt').text(Math.round(($(this).val()*parseFloat($('.rateclass').text()))+' '));formatNumber ($('.rslt'));}" disabled="{!IF(activity.valVisible==false,false,false)}" id="hoursSelected" onkeyup="   if($(this).val()<0)  $(this).val($(this).val()*-1);" />
                                        <!--input type="number" class="hourly_rate_box" name="hourlyRate" /-->hours
                                        <!--button class="btn btn-primary btn_plus btn_asset_add" onclick="addToActivitySelectionMap();">ADD</button-->
                                        <apex:commandButton value="ADD" styleClass="btn btn-primary btn_plus btn_asset_add" onclick="addToActivitySelection(); return false;" />
                                    </p>
                                </div>
                            </div>
                        </apex:outputPanel>
                            <apex:outputPanel id="selectionTable"  >
                                <apex:outputPanel rendered="{!IF(selectedActivitiesSize > 0, true, false)}">
                                    <table class="table table-striped" id="swopTable">
                                        <thead>
                                            <tr>
                                                <td style="display:none;">key</td>
                                                <td style="display:none;">Activity Id</td>
                                                <th>Activity</th>
                                                <th>Country</th>
                                                <th>Agency department</th>
                                                <th>Role</th>
                                                <th>Hourly rate</th>
                                                <th>Hours</th>
                                                <th>Total €</th>
                                                <th></th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <apex:repeat value="{!activitySelectionMap}" var="eachActivity">
                                                <tr onclick="setActivityInputFieldsForSelectedItem('{!activitySelectionMap[eachActivity].selectedActivity}', '{!activitySelectionMap[eachActivity].selectedCountryname}', '{!activitySelectionMap[eachActivity].selectedAgencyDepartment}', '' ,'{!activitySelectionMap[eachActivity].selectedRole}', {!activitySelectionMap[eachActivity].hoursSelected}, {!activitySelectionMap[eachActivity].hourlyRate});">
                                                    <th style="display:none;" id="idColumn_{!activitySelectionMap[eachActivity].key}">{!activitySelectionMap[eachActivity].key}</th>
                                                    <th style="display:none;" id="idColumn_{!activitySelectionMap[eachActivity].activityId}">{!activitySelectionMap[eachActivity].activityId}</th>
                                                    <td>{!activitySelectionMap[eachActivity].selectedActivity}</td>
                                                    <td>{!activitySelectionMap[eachActivity].selectedCountryname}</td>
                                                    <td>{!activitySelectionMap[eachActivity].selectedAgencyDepartment}</td>
                                                    <td>{!activitySelectionMap[eachActivity].selectedRole}</td>
                                                    <td>{!activitySelectionMap[eachActivity].hourlyRate}</td>
                                                    <td>{!activitySelectionMap[eachActivity].hoursSelected}</td>
                                                    <td>
                                                        <apex:outputText value="{0, number,###,###,##0}"> 
                                                            <apex:param value="{!activitySelectionMap[eachActivity].totalAmount}"/>
                                                        </apex:outputText>
                                                    </td>
                                                    <td>
                                                        <a href="#" id="removeRow_{!activitySelectionMap[eachActivity].key}" value="{!activitySelectionMap[eachActivity].key}" onclick="removeRow('{!activitySelectionMap[eachActivity].key}');"> <img alt="Remove" src="{!URLFOR($Resource.Oblix_SwopAssets, 'Oblix_SwopAssets/images/redcross.png')}" width="12" height="12" />
                                                        </a>
                                                    </td>
                                                </tr>
                                            </apex:repeat>
                                        </tbody>
                                    </table>
                                    <apex:commandButton value="ADD SELECTION TO BASKET" styleClass="btn btn-primary btn-xs pull-right btn_plus btn_add_selection" onclick="insertSelectedActivities(); return false;" />
                                </apex:outputPanel>
                            </apex:outputPanel>
                        </div>
                            <div class="tab-pane" id="resource">
                                <apex:outputPanel id="resource_input_fields">
                                <div class="row">
                                    <div class="col-lg-4">
                                        <p class="create_SOW_form_titles">Resource Name*</p>
                                        <apex:inputField styleClass="resource_name_box_align" value="{!resource.nonCampaignItem.name}" id="dedicatedResourceName"  />
                                    </div>
                                    <div class="col-lg-4">
                                        <p class="create_SOW_form_titles">Country*</p>
                                        <apex:selectList size="1" value="{!resource.selectedCountryname}" onchange="adupdate('resource');blockme();" styleclass="investment_project_dropdowns_right" id="dedicatedCountry">
                                            <apex:selectOptions value="{!countries}" />
                                        </apex:selectList>
                                    </div>
                                    <div class="col-lg-4">
                                        <p class="create_SOW_form_titles">Agency department*</p>
                                        <apex:selectList size="1" value="{!resource.selectedAgencyDepartment}" styleclass="picklist_init" id="dedicatedAgencyDepartment" onchange="RTupdate('resource');blockme();" disabled="{!IF(resource.agencyVisible==false,true,false)}" style="min-width:100%;">
                                            <apex:selectOptions value="{!resourceAgencyDepartment}" />
                                        </apex:selectList>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-lg-4 non_camp_dropdown_spacing">
                                        <p class="create_SOW_form_titles">Role*</p>
                                        <apex:selectList size="1" value="{!resource.selectedRole}" id="dedicatedSelectedRole" styleclass="picklist_init" style="min-width:100%;" disabled="{!IF(resource.roleVisible==false,true,false)}" onchange="Rateupdate('resource');blockme();">
                                            <apex:selectOptions value="{!resourceRoleTitle}" />
                                        </apex:selectList>
                                    </div>
                                    <div class="col-lg-8 non-campaign_hourly_rate_section yearly_rate_form_align">
                                        <p>Yearly rate €&nbsp;&nbsp;
                                            <apex:outputLabel value="{!resource.hourlyRate}" id="dedicatedRate" />
                                            <!--apex:input type="number" styleClass="hourly_rate_box" html-min="0" value="{!resource.hoursSelected}" onchange="if(!isNaN(parseInt($('.rateclass').text()))){ $('.rslt').text(Math.round(($(this).val()*parseFloat($('.rateclass').text()))+' '));formatNumber ($('.rslt'));}" disabled="{!IF(resource.valVisible==false,false,false)}" id="dedicatedHoursSelected" onkeyup="   if($(this).val()<0)  $(this).val($(this).val()*-1);" /-->&nbsp;&nbsp;
                                            <apex:input type="number" styleclass="prcentt input_init" html-min="0" html-max="100" value="{!resource.hoursSelected}"  style="width:40px;" onchange="if(!isNaN(parseInt($('.rateclass1').text()))){ $('.rslt1').text(Math.round($(this).val()/100*parseFloat($('.rateclass1').text()).toFixed(2))); formatNumber ($('.rslt1'));}" id="prcent"   onkeyup="   if($(this).val()<0)  $(this).val($(this).val()*-1);  if($(this).val()>100)  $(this).val(100);  " />
                                            <!--input type="number" class="hourly_rate_box" name="hourlyRate" /-->%
                                            <!--button class="btn btn-primary btn_plus btn_asset_add" onclick="addToActivitySelectionMap();">ADD</button-->
                                            <apex:commandButton value="ADD" styleClass="btn btn-primary btn_plus btn_asset_add" onclick="validateResourceSelection(); return false;" />
                                        </p>
                                    </div>
                                </div>
                                </apex:outputPanel>
                            </div>
                    </div>
                </div>
                <div class="col-lg-3 asset_shopping_basket_margin">
                    <apex:outputPanel id="shoppingBasketPanel">
                        <div class="asset_shopping_basket">
                            <div class="asset_shopping_basket_title_bar">
                                <h2>Non Campaign Basket ({!campaignBasketList.size})</h2>
                            </div>
                                
                            <apex:repeat value="{!campaignBasketList}" var="eachItem">
                                <div class="asset_shopping_basket_item">
                                    <div class="campaign_create_agency_hub_split_table_subtitle padding_bottom0">
                                        <a href="#" id="basketRemoveRow_{!eachItem.activityName}" value="{!eachItem.activityName}" onclick="basketRemoveRow('{!eachItem.activityName}');"><img alt="Remove" src="{!URLFOR($Resource.Oblix_SwopAssets, 'Oblix_SwopAssets/images/redcross.png')}" class="attachement_redcross" height="12" width="12" /></a>
                                        <a href="#" id="basketItem_{!eachItem.activityName}" onclick="getAndSetActivitiesByName('{!eachItem.activityName}');blockme();">{!eachItem.activityName} - €<apex:outputText value="{0, number,###,###,##0}"> <apex:param value="{!eachItem.totalAmount}"/></apex:outputText>
                                        </a>
                                    </div>
                                </div>    
                            </apex:repeat>
                                
                            <div class="asset_shopping_basket_total">
                                <div class="row">
                                    <div class="col-lg-8">
                                        <p class="asset_shopping_basket_total_fee_text">Non Campaign Estimated Fees</p>
                                    </div>
                                    <div class="col-lg-4">
                                        <h2 class="asset_shopping_basket_total_fee_value">€<apex:outputText value="{0, number,###,###,##0}">
                                                                                                <apex:param value="{!campaignTotalValue}"/>
                                                                                            </apex:outputText></h2>
                                    </div>
                                </div>
                            </div>
                            <div class="asset_shopping_basket_btn">
                                <apex:commandButton value="FINISH WITH BASKET" styleClass="btn btn-primary btn-xs btn_check btn_finish_basket" action="{!finishBasket}" />
                            </div>
                        </div>
                    </apex:outputPanel>
                </div>
            </div>

        </div>
    </apex:form>
</apex:page>