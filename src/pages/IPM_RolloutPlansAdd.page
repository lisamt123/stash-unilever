<!--  
*************************************************************************
*@Description:This page is used to generate rollouts and selecting countries for the corresponding rollouts
*@Author: Cognizant
*@Created Date: 22/02/2015
*@Copyright Â© 2015  Unilever  
*************************************************************************
-->

<apex:page controller="IPM_RolloutPlansAddController" sidebar="false" standardStylesheets="false" extensions="IPM_GetHelpDoc"> 
    <apex:stylesheet value="{!URLFOR($Resource.IPM_Resource, 'css/IPM_RolloutPlansAdd.css')}"/> 
    <apex:composition template="IPM_TemplateRevamp">
        <apex:define name="body">          
                <apex:form >
                <div class="gradientbg">  
                    <c:IPM_ProjectDetails project="{!project}" activeItem="rolloutPlan" />
                 </div>
             <apex:outputPanel id="theForm" layout="block">
                <apex:outputPanel rendered="{!isError}">
                    <div class="finGreyBG">
                        <apex:outputText value="{!errorMessage}" />
                    </div>
                </apex:outputPanel>
                <apex:outputPanel layout="block" rendered="{!AND(isEditable,NOT(isError))}">
                    <div class="ipmContent">
                        <div class="row finwrapper">
                            <div class="col-sm-12">
                                <div class="panel-group pageHeadToolbar clearfix">
                                    <div class="row">
                                    
                                    <!-- To place the help symbol in the top right hand corner of page -->
                                    <apex:outputPanel layout="block" styleClass="SecButtonSet delete pull-right" >
                                        <apex:outputLink value="{!URL}" id="theLink" styleClass="icoButton question" target="_blank" title="{!$Label.IPM_Help}">?</apex:outputLink>
                                    </apex:outputPanel> 
                                        <div class="col-sm-5 pull-left">
                                            <h3 class="pageTitle">{!$Label.IPM_ADD_ROLLOUT}</h3>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>                        
                        <div class="searchBox"><label class="greytext"></label> <apex:inputtext value="{!searchCountry}" html-placeholder="{!$Label.IPM_Search_MCO_Country_Name}" styleclass="placeholder" /><img alt="Search" class="srchImage" src="{!URLFOR($Resource.IPM_Resource, 'images/search.svg')}" onclick="callsearch();"/></div>
                        <apex:actionFunction action="{!searchRolloutCountry}" name="callsearch"/>
                        <apex:outputText value="{!$Label.IPM_Rollout_Search_Message}" rendered="{!isNoResult}" styleclass="finGreyBG"/>
                        <apex:outputPanel rendered="{!!isNoResult}">
                            <div class="row">
                                <apex:outputPanel id="contentPanel">
                                    <div class="col-sm-12 mb20">
                                        <div class="col-sm-4 clusterbg">
                                            <div class="subheader">{!$Label.IPM_MARKET_CLUSTER}</div>
                                            <ul class="messageFilter">
                                                <apex:repeat value="{!lstClusterWrappers}" var="cluster">
                                                    <li class="{!IF(cluster.code == selectedCluster, 'isSelected', '')}">
                                                        <a class="noDecoration changeClusterTab" id="{!cluster.code}">
                                                            {!cluster.name}
                                                            <span><i class="fa fa-chevron-right"></i></span>
                                                        </a>
                                                    </li>
                                                </apex:repeat>
                                            </ul>
                                        </div>
                                        <div class="col-sm-4 mcobg">
                                            <div class="subheader">{!$Label.IPM_MCO}</div>
                                            <ul class="mcoFilter">
                                                <apex:repeat value="{!lstMCOWrappers}" var="mco">
                                                    <li class="{!IF(mco.code == selectedMCO, 'isSelected', '')}">
                                                        <a class="noDecoration changeMCOTab" id="{!mco.code}">
                                                            {!mco.name}
                                                            <span><i class="fa fa-chevron-right"></i></span>
                                                        </a>
                                                    </li>
                                                </apex:repeat>
                                            </ul>
                                        </div>
                                        <div class="col-sm-4 countrybg">
                                            <div class="subheader">
                                                {!$Label.IPM_COUNTRY}
                                                <span class="btext pull-right">
                                                    {!$Label.IPM_MARK_THIS_MCO_AS_KEY}
                                                    <div class="btm2 ipmCheckbox">
                                                        <input class="notselected {!IF( OR (mapMCOWrappers[selectedMCO].key,AND(NOT(mapMCOWrappers[selectedMCO].mcoDisabled),project.IPM_Phase__c !='Ideas') ), 'selected', '')} {!IF(OR(mapMCOWrappers[selectedMCO].mcoDisabled,project.IPM_Phase__c !='Ideas'), 'disabled', '')}" id="keyMCO" type="checkbox"/> 
                                                        <label class="notselected left13" for="keyMCO"></label>
                                                    </div>
                                                </span>
                                            </div>
                                            <apex:outputPanel id="countryBlock"> 
                                                <ul class="countryFilter">
                                                    <li>
                                                        {!$Label.IPM_ROLLOUT_IN}
                                                        <span class="Rolloutselectall">
                                                            <div class="pull-left innertext">Select All</div>
                                                            <div class="pull-left ipmCheckbox checkAll">
                                                                <input class="notselected {!IF(mapMCOWrappers[selectedMCO].mcoDisabled == true, 'disabled', '')}" id="selectAll" type="checkbox"/> 
                                                                <label class="notselected" for="selectAll"></label>
                                                            </div>
                                                        </span>
                                                    </li>
                                                    <div class="countriesList">
                                                        <apex:repeat value="{!lstCountryWrappers}" var="country">
                                                            <li class="countryList">
                                                                {!country.name}
                                                                <span>
                                                                    <div class="pull-left ipmCheckbox">
                                                                        <input class="notselected chkList {!IF(country.selected,'selected','')} {!IF(country.countryDisabled,'disabled','')}" value="{!country.code}" id="{!country.code}" type="checkbox"/> 
                                                                        <label for="{!country.code}"></label>
                                                                    </div>
                                                                </span>
                                                            </li>
                                                        </apex:repeat>
                                                    </div>
                                                </ul>
                                            </apex:outputPanel>
                                        </div>
                                    </div>
                                </apex:outputPanel>
                                <div class="col-sm-12 text-right">
                                    <apex:commandLink styleClass="ipmButton buttonMarginRight" action="{!cancel}" value="{!$Label.IPM_CANCEL}" status="loadingStatus"/>
                                    <apex:commandButton styleClass="ipmButton buttonMarginRight primary generateRolloutBtn" oncomplete="GotoParentPage();" value="{!$Label.IPM_GENERATE_ROLLOUTS}" />                                    
                                    
                                </div>
                            </div>
                        </apex:outputPanel>    
                    </div>
                </apex:outputPanel>                   
                
                <apex:actionFunction name="changeCluster" action="{!changeCluster}" reRender="theForm,scriptPanel" status="loadingStatus" oncomplete="scriptPanelLoad();">
                    <apex:param name="p1" assignTo="{!globalCountries}" value=""/>
                    <apex:param name="p2" assignTo="{!globalUnselectedCountries}" value=""/>
                    <apex:param name="p3" assignTo="{!selectedCluster}" value=""/>
                    <apex:param name="p4" assignTo="{!previouselectedMCO}" value=""/>
                    <apex:param name="p5" assignTo="{!selectedKey}" value=""/>
                </apex:actionFunction>
                <apex:actionFunction name="changeMCO" action="{!changeMCO}" reRender="theForm,scriptPanel" status="loadingStatus" oncomplete="scriptPanelLoad();">
                    <apex:param name="p1" assignTo="{!globalCountries}" value=""/>
                    <apex:param name="p2" assignTo="{!globalUnselectedCountries}" value=""/>
                    <apex:param name="p3" assignTo="{!selectedMCO}" value=""/>
                    <apex:param name="p4" assignTo="{!previouselectedMCO}" value=""/>
                    <apex:param name="p5" assignTo="{!selectedKey}" value=""/>
                </apex:actionFunction>
                <apex:actionFunction name="generateRollouts" action="{!generateRollouts}" rerender="theForm" status="loadingStatus" oncomplete="scriptPanelLoad();setRedirect();">
                    <apex:param name="p1" assignTo="{!globalCountries}" value=""/>
                    <apex:param name="p2" assignTo="{!globalUnselectedCountries}" value=""/>
                    <apex:param name="p3" assignTo="{!previouselectedMCO}" value=""/>
                    <apex:param name="p4" assignTo="{!selectedKey}" value=""/>
                </apex:actionFunction>      
                          
                <script src="{!URLFOR($Resource.IPM_Resource, 'js/jquery.clearsearch.js')}" type="text/javascript"></script> 
                <apex:outputPanel id="scriptPanel">
                    <script>
                           var IPMRollOutAdd = {SelectedMCO:'{!JSENCODE(selectedMCO)}'};
                           
                            var jq= jQuery.noConflict();
                            jq(document).ready(function(){
                                    jq(".ipmAccordion").find(".pHead:first span.expico-square").removeClass("fa-plus").addClass("fa-minus");
                                    
                                            var selectedCountries=[];
                                            var unselectedCountries=[];
                                            
                                             jq(document).off('click', '.changeMCOTab').on('click','.changeMCOTab', function(){
                                                var changeMCOTab = jq(this);
                                                // passed from front end
                                                var previousMcoCode = IPMRollOutAdd.SelectedMCO;
                                                var mcoCode = changeMCOTab.attr('id');
                                                var keyMCO = jq('#keyMCO').is(":checked");
                                                
                                                jq('.countryFilter .countryList input:checkbox').each(function(){
                                                    var cntryInput = jq(this);
                                                    if(cntryInput.is(":checked")){
                                                        selectedCountries.push(cntryInput.attr('id'));
                                                    } else {
                                                        unselectedCountries.push(cntryInput.attr('id'));
                                                    }
                                                });
                                                changeMCO(selectedCountries.toString(),unselectedCountries.toString(),mcoCode,previousMcoCode,keyMCO);
                                            });
                                            
                                           jq(document).off('click', '.changeClusterTab').on('click','.changeClusterTab', function(){
                                                var previousMcoCode = IPMRollOutAdd.SelectedMCO;
                                                var clusterCode = jq(this).attr('id');
                                                var keyMCO = jq('#keyMCO').is(":checked");
                                                
                                                jq('.countryFilter .countryList input:checkbox').each(function(){
                                                    var cntryInput = jq(this);
                                                    if(cntryInput.is(":checked")){
                                                        selectedCountries.push(cntryInput.attr('id'));
                                                    } else {
                                                        unselectedCountries.push(cntryInput.attr('id'));
                                                    }
                                                });
                                                changeCluster(selectedCountries.toString(),unselectedCountries.toString(),clusterCode,previousMcoCode,keyMCO);
                                            });
                                            
                                            jq(document).off('click', '.generateRolloutBtn').on('click','.generateRolloutBtn', function(){
                                                var previousMcoCode = IPMRollOutAdd.SelectedMCO;
                                                var keyMCO = jq('#keyMCO').is(":checked");
                                                jq('.countryFilter .countryList input:checkbox').each(function(){
                                                    var cntryInput = jq(this);
                                                    if(cntryInput.is(":checked")){
                                                        selectedCountries.push(cntryInput.attr('id'));
                                                    } else {
                                                        unselectedCountries.push(cntryInput.attr('id'));
                                                    }
                                                });
                                                generateRollouts(selectedCountries.toString(),unselectedCountries.toString(),previousMcoCode,keyMCO);
                                                var projectId = "{!projectId}";
                                                                    
                                            });
                                            
                                            jq(document).off('click', '#selectAll').on('click','#selectAll', function(){
                                                var $this = jq(this);
                                                var findInput = $this.closest("ul").find("li input[type=checkbox]");
                                                var findLabel = $this.closest("ul").find("li label");
                                                if($this.is(":checked")){
                                                    findInput.prop("checked", true);
                                                    findLabel.addClass("selected");
                                                }else{
                                                    findInput.prop("checked", false);
                                                    findLabel.removeClass("selected");
                                                }
                                            });
                                            
                                            jq(document).off('click', '#selectproLeader').on('click', '#selectproLeader', function(e) {
                                                
                                               e.preventDefault ? e.preventDefault() : e.returnValue = false;
                                               var url = jq(this).attr('value');
                                               var mtitle = jq(this).attr('html-text');
                                               jq("#ipmAddMemberModal .modal-body").html('<iframe frameborder="0" height="100%" width="100%" marginheight="0" marginwidth="0" allowtransparency="true" src= "' + url + '"></iframe>');
                                               jq('#ipmAddMemberModal .modal-dialog').width('700px');
                                               jq('#ipmAddMemberModal .modal-dialog').height('610px');
                                               jq('#ipmAddMemberModal .modal-dialog').css({'margin-top': '2%','z-index': '999'});
                                               jq('#ipmAddMemberModal .modal-title').html(mtitle);
                                           });
                                scriptPanelLoad();  
                                    
                            });
                            
                            function setFocusOnLoad() {}
                            
                            function scriptPanelLoad(){
                                var keyMCO = jq('#keyMCO');
                                var srchTxt = jq('#srchTxt');
                                jq('.placeholder').clearSearch();
                               jq('.countrybg input:checkbox').each(function(){
                                    var $this = jq(this);
                                    if($this.hasClass('selected')){
                                        $this.prop('checked', 'true');
                                    }
                                    
                                    if($this.hasClass('disabled')){
                                        $this.prop('disabled', 'true');
                                    }
                                }); 
                                
                                    if(keyMCO.hasClass('selected')){
                                        keyMCO.prop('checked', 'true');
                                    }
                                    srchTxt.addClass('placeholder');
                                    srchTxt.val(srchTxt.attr('placeholder'));   
                                    jq( ".placeholder" ).on( "keypress", function(event) {
                                          if(event.which == 13) {                                      
                                          callsearch();
                                          return false;        
                                          }
                                     });                  
                            }  

                           function setRedirect()
                           {
                               if({!isCompleted})
                               {
                                   window.top.location = '{!URLFOR($Page.IPM_RolloutPlans)}?Id={!projectId}&EditMode=false';
                               }
                           }
                    </script>
                 </apex:outputPanel>
             </apex:outputPanel>
        </apex:form>
    </apex:define>
</apex:composition>
</apex:page>