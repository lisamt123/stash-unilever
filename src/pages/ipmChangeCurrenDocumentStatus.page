<apex:page controller="IPM_ChangProjectDocumentStatusController" title="Change current document status" standardStylesheets="true" sidebar="false" showHeader="false">
   
    <apex:stylesheet value="{!URLFOR($Resource.ipmResourceRevamp, 'css/ipmButtons.css')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.ipmResource, 'css/jquery-ui.css')}"/>
    <!--<link href="http://ajax.googleapis.com/ajax/libs/jqueryui/1/themes/smoothness/jquery-ui.min.css" rel="stylesheet" type="text/css" />-->
    <apex:includeScript value="{!URLFOR($Resource.ipmResource, 'js/jquery.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.ipmResource, 'js/bootstrap.js')}"/>
    <apex:includeScript value="{!URLFOR($Resource.ipmResource, 'js/jquery-ui.js')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.ipmResource, 'assets/font-awesome/css/font-awesome.min.css')}"/>
     <apex:stylesheet value="{!URLFOR($Resource.ipmResource, 'css/bootstrap.css')}"/>
    <style>
        .marginTop{margin-top:20px;}
        .inputField{margin-bottom:15px;}
        .inputField input, .inputField select{width:100%;height:30px;border-radius: 3px; border: 1px #a8a8a8 solid;}
        .input-group-addon{padding: 0px;margin-top: -3px;width: 1px;background:none; border:none;color: #007dbb;font-size: 1.3em;}
        /*.fa-calendar:before{margin-left: -41px;}*/
        .middlePanel{background:#f9f9f9; border-top:1px #d7e1e0 solid; border-bottom:1px #d7e1e0 solid;margin-bottom: 10px;padding-top: 5px;}
        .fieldFont{font-size:0.8em; color:#555555;} 
        .fieldLabel{padding-top:10px; padding-bottom:10px; font-weight:bold;}
        .modal-backdrop.in {opacity: 0.7;}
        .date input{height:30px;border-radius: 4px;border: 1px #ddd solid;width:41%;}
        .input-group .input-group-addon {position: absolute;top: 53px;left: 36%;} 
        .input-group.date{width:100%;padding:20px 0;}
        .input-group.date label{display:block;}
         div[class^="col-xs-"]{padding:5px 10px;} 
        .changeStatusPage textarea{width:100%;}
        .changeStatusPage {/*background:#f9f9f9; border-bottom:1px #d7e1e0 solid;*/padding-bottom:10px;}
        
        /*ipmButton Styles */
        .ipmButton{padding: 7px 0;font-size: 1em;border-radius: 2px;color: white;border: 1px #406b14 solid;text-transform: capitalize;height: 30px;text-decoration: none;width:100%}
        .ipmButton.green{background:#81bf42 !important;}
        .ipmButton.green:hover{background:#56843b !important;}
         #changeStatus .ipmButtonGroup {padding-bottom: 4%;padding-right: 6px; position:relative;}         
        
        /*slider styles*/
        #slider {margin-bottom:20px;}
        #slider::before {content:"";display:block;position:absolute;left:0; top:-7px; border:1px solid #252525; background:#fff; width:7px; height:20px; border-radius:5px; -webkit-border-radius:5px; -webkit-border-radius:5px;}
        #slider::after {content:"";display:block;position:absolute;right:-4px; top:-7px; border:1px solid #252525; background:#fff; width:7px; height:20px; border-radius:5px; -webkit-border-radius:5px; -webkit-border-radius:5px;}
        #legend {position:relative; top:20px;}
        #legend label {display: inline-block;cursor:pointer; position:relative; font-size:0.8em;font-weight:normal;color:#555555;}
        #legend label[for=statusRadioBtn_0] {text-align:left;left:-30px;}
        #legend label[for=statusRadioBtn_1] {text-align:center;}
        #legend label[for=statusRadioBtn_2] {text-align:center;}
        #legend label[for=statusRadioBtn_3] {text-align:right;right:-30px;}
        #legend label[for=statusRadioBtn_1]:before, #legend label[for=statusRadioBtn_2]:before {content:"";display:block;position:absolute;left:50%; top:-27px; border:1px solid #252525; background:#fff; width:7px; height:20px; border-radius:5px; -webkit-border-radius:5px; -webkit-border-radius:5px;}
        .slider3 #legend label[for=statusRadioBtn_2]:before {display:none!important;}
        .sliderDiv{margin-top:20px;} 
        .sliderDiv:after {display:block; clear:both: content:" "; visibility:hidden;}   
        #changeStatus{margin:20px 0 0 0;padding:0 15px;}       
        .infoMsg{padding:10px;font-size:0.82em;background:#e5f8ff;border:1px #1568b6 solid;color:#007dbb; border-radius:2px;}       
        .toolTipMsg{background:#fafafa;border:1px #c9c9c9 solid; border-radius:2px;color:#364354;font-size:0.82em;position:relative;}          
        .toolTipMsg::before { left: 5%;top: -8px; position: absolute; border-top: 1px #c9c9c9 solid;border-right: 1px #c9c9c9 solid;background: #fafafa;content: " ";height: 15px;width: 15px;transform: rotate(-45deg);-moz-transform: rotate(-45deg);-webkit--transform: rotate(-45deg);-ms-transform: rotate(-45deg); }
        .toolTipMsg label {font-weight:normal;}
        .ui-slider-handle {border-radius:50%!important;-moz-border-radius:50%!important;-webkit-border-radius:50%!important;background:#EDEDED !important;border:1px solid #8F8F8F !important;}
        .ui-slider-horizontal {height:0.4em!important; border:none!important;background:#DCDCDC !important;width:90%!important; margin:0 auto;}
        .ui-slider-horizontal .ui-slider-handle {top:-0.6em!important;}
        .ui-slider .ui-slider-handle {width:1.6em!important; height:1.6em!important;}
                
        .aprove>i {1px #c9c9c9 solid;}
        .postpone .toolTipMsg::before {left: 64%;}
        .approve .toolTipMsg::before {left: 93.5%;}
        .slider3 .stop .toolTipMsg::before {left: 94%;}
        .slider4 .stop .toolTipMsg::before {left: 34%;}
        .slider3 .propose .toolTipMsg::before {left: 49.1%;}
        .slider4 .propose .toolTipMsg::before {left: 5%;}
        .messageBox .SecButtonSet {margin-top:0!important; position:relative; top:2px;}
        .messageBox .SecButtonSet .icoButton {width:16px!important;height:16px!important;top: -3px; }
        .messageBox .SecButtonSet a {display:block; float:left; border:1px solid #015ba7; cursor:default; border-radius:50%; -moz-border-radius:50%; -webkit-border-radius:50%;}
        .messageBox .SecButtonSet span.msgTxt {position: relative; top: -2px; display:block; margin-left:25px;}
    
        .ipmButtonGroup { position:relative;} 
        .ipmButtonGroup .proInit {text-align: center; position:absolute; z-index:100; top:0; left:0; width:103%; height:103%; background:#fff url({!URLFOR($Resource.ipmResourceRevamp, 'images/ajax-loader.gif')}) no-repeat 0 0!important;}
        .message.errorM3{  color: #d74c3b; display: block;  padding: 10px;  background: #ffebec; margin: 15px;}
    </style>
<apex:form >
<apex:pagemessages id="pmsg" escape="false"></apex:pagemessages>
<apex:outputPanel id="srcp">
<script>
 var status='{!status}';
 var makeValid = {!showValidation};
 var stopvalid='{!projectDoc.IPM_Stopped_Comments__c}';
 var postpdate='{!projectDoc.IPM_Postponement_Date__c}';
 var postpComment='{!projectDoc.IPM_Postponed_Comments__c}';
</script>
</apex:outputPanel>

<apex:outputPanel id="goto">
</apex:outputPanel> 
<div class="container-fluid">
<div class="row changeStatusPage">
<div class="col-xs-12" id="changeStatus">
<div class="col-xs-12 messageBox infoMsg">
<div class="SecButtonSet">
<a class="icoButton info" title="info"></a>
<span class="msgTxt">Once you have changed the status, you cannot undo it.</span>
</div>
</div>
<div class="col-xs-12 sliderDiv">
    <div id="slider">
    <div id="legend"></div>
    </div>
    
</div>

<!-- For In-Progress State --> 
<apex:outputPanel id="progress" styleClass="progress">
<apex:outputPanel rendered="{!If(Status='In Progress',true,false)}">
<div class="col-xs-12 toolTipMsg marginTop"><apex:outputText value="In progress means that you are working on the Gate document and it is not ready to be proposed."/></div>
</apex:outputPanel>
</apex:outputPanel>

<!-- For Stopped State --> 
<apex:outputPanel id="stop" styleClass="stop">
<apex:outputPanel rendered="{!If(Status='Stopped',true,false)}">

<div class="col-xs-12 toolTipMsg marginTop"><apex:outputText value="Stopped means that the project will be stopped and it will not be available in your active projects"/>
</div>
<apex:outputLabel styleClass="marginTop" value="Comments and required actions from Gate Meeting"/><br/>
<apex:inputTextarea value="{!projectDoc.IPM_Stopped_Comments__c}"/>
</apex:outputPanel>
</apex:outputPanel>

<!-- For Proposed State --> 
<apex:outputPanel id="propose" styleClass="propose">

<apex:outputPanel rendered="{!If(Status='Proposed',true,false)}" > 
<div class="col-xs-12 toolTipMsg marginTop"><apex:outputText value="Proposed means that the Gate document is ready to be submitted for Gate meeting. You won't be able to update any section after proposing the document."/></div>
<apex:outputPanel rendered="{!showSkipSections}">
<div class="col-xs-12 messageBox infoMsg marginTop">
<div class="SecButtonSet">
<a class="icoButton info" title="info"></a>
<span class="msgTxt">Sorry! this cannot be proposed yet. The non-negotiable sections and few other details listed below are incomplete. Please go back and fill them in.</span> 
</div>
</div>
<apex:outputLabel value="Non-negotiable sections" styleClass="fieldLabel fieldFont"/><br/>
    <apex:repeat value="{!projSectionList}" var="section">
       <!-- <apex:outputLabel value="{!section.IPM_Section_Sequence__c} {!section.IPM_Section_Name__c}" styleClass="fieldLabel fieldFont"/> <br/>-->
        
        <a href="/apex/ipmProjectDocumentSectionEditorV1?id={!project.Id}&&projDocSecId={!section.Id}" target="_top" >{!section.IPM_Section_Sequence__c} {!section.IPM_Section_Name__c}</a><br/>
       <apex:inputTextArea value="{!section.IPM_Gate_Document_Summary__c}"/> <br/>
    </apex:repeat>
</apex:outputPanel>
</apex:outputPanel>
</apex:outputPanel>

<!-- For Postponed State --> 
<apex:outputPanel id="postpone" styleClass="postpone">
<apex:outputPanel rendered="{!If(Status='Postponed',true,false)}" > 
<div class="col-xs-12 toolTipMsg marginTop"><apex:outputLabel value="This state indicates that the Gate Document is being Postponed. You can retrieve it from Project archive later." /></div>
<apex:outputPanel >
<div class='input-group date'>
<apex:outputLabel value="Postpone On"/>
<apex:inputField value="{!projectDoc.IPM_Postponement_Date__c}" id="Duedate">
<span class="input-group-addon" id="datepicker">
<span class="fa fa-calendar"></span>
</span>
</apex:inputField>
</div>
<apex:outputLabel value="Comments and required actions from Gate Meeting"/><br/>
<apex:inputTextarea value="{!projectDoc.IPM_Postponed_Comments__c}"/><br/>
</apex:outputPanel>
</apex:outputPanel>
</apex:outputPanel>

<!-- For Approved State -->
<apex:outputPanel id="approve" styleClass="approve">
    <apex:outputPanel rendered="{!If(Status='Approved',true,false)}" > 
    <div class="col-xs-12 toolTipMsg marginTop"><apex:outputLabel value="This state indicates that the Gate Document is Approved and there is no more action to be taken by Project Leader." /></div>
    <apex:outputPanel >
       <!-- <div class='input-group date'>
            <apex:outputLabel value="Approved On"/>
            <apex:inputField value="{!projectDoc.IPM_Approval_Date__c}" >
            <span class="input-group-addon fa fa-calendar" id="datepicker" />
            </apex:inputField>
        </div> -->
        <apex:outputLabel value="Comments and required actions from Gate Meeting"/> <i>(Optional)</i><br/>
        <apex:inputTextarea value="{!projectDoc.IPM_Approved_Comments__c}"/><br/>
       
    
    
        <apex:outputPanel rendered="{!if(projectDoc.IPM_GateDocuments__c=='Charter',True,False)}">
            <apex:outputLabel value="IPM Gate Keeping Module"/>
            <apex:inputField value="{!project.IPM_GateKeeping_Model__c}" >
            </apex:inputField>
        </apex:outputPanel>   
     </apex:outputPanel>
    
    </apex:outputPanel>
</apex:outputPanel>

</div>
</div>
<div class="col-xs-3 marginTop ipmButtonGroup pull-right">
    <apex:actionStatus startText="" id="Loading" startStyleClass="proInit"/>
    <apex:commandButton value="Submit" action="{!submit}"  status="Loading" oncomplete="GotoParentPage();" reRender="srcp,pmsg" styleClass="ipmButton primary"/>
    <!-- <apex:commandLink value="Submit" action="{!submit}" styleClass="ipmButton primary"/>-->
</div>
</div>
<apex:actionFunction action="{!updateStatus}" name="changeStatus" reRender="progress,propose,postpone,approve,stop,goto" >
<apex:param name="status" value="" id="statusChange" assignTo="{!Status}" />
</apex:actionFunction>
<apex:actionFunction name="sendemailtoGK" action="{!sendEmail}" reRender=""/>

</apex:form>
<apex:includeScript value="{!URLFOR($Resource.ipmResource, 'js/bootstrap-datepicker.js')}"/>
        <apex:stylesheet value="{!URLFOR($Resource.ipmResource, 'css/datepicker.css')}"/>               
        <script type="text/javascript">
            var jq=jQuery.noConflict();
            var dateFormat = "dd/mm/yyyy";
            jq.browser = {};
            jq(function() {
                jq('.date').datepicker({
                    format:dateFormat ,
                    autoclose:true,
                    startDate:new Date(),
                    startView:0,
                });
                jq("[id$=mlktp]").hide();
                jq('.date .dateInput .dateFormat').hide();
                
                var items =[ 'In Progress','Proposed','Stopped'];
                var itemsProposed = [ 'Proposed','Stopped','Postponed','Approved'];
                var s = jq("#slider");
                
                var status = "{!projectDoc.IPM_Document_Status__c}";     

                var PointerT = 100 / (items.length-1);
                var PointerF = 100 / (itemsProposed.length-1);
                
                if(status =='Proposed' || status =='Postponed') {                 
                 s.slider({
                  min:1,
                  max:itemsProposed.length,
                  animate:'slow',
                  stop: function(event, ui){   
                            
                            var pointer = ui.value-1;
                            jq('#statusRadioBtn_'+ ui.value).prop('checked', true); 
                            jq("label").css({'color':'rgb(34, 34, 34)'});
                            jq("label[for=statusRadioBtn_"+ pointer +"]").css({'color':'#e98824'});
                            if(status=='Postponed' && pointer == 0){                            
                            jq('.ui-slider-handle').animate({'left':'66.66%'}, 100);                            
                            jq("label[for=statusRadioBtn_0").css({'color':'rgb(34, 34, 34)'});
                            jq("label[for=statusRadioBtn_2").css({'color':'#e98824'}); 
                            changeStatus(itemsProposed[ui.value+1]);
                            }
                            if(status=='Postponed' && itemsProposed[ui.value-1]!='Proposed')
                            {                            
                            changeStatus(itemsProposed[ui.value-1]);
                            } else if(status=='Proposed') {
                            changeStatus(itemsProposed[ui.value-1]);
                            }     
                      }
                });
                jq("#changeStatus").addClass("slider4");
                jq.each(itemsProposed, function(key,value){
                  var w = PointerF;
                  if(key === 0 || key === itemsProposed.length-1)
                    w = PointerF/2;
                  jq("#legend").append("<label style='width: "+w+"%' for='statusRadioBtn_"+key +"'>"+value+"</label><input type='radio' name='gateStatus' value='"+value+"' id='statusRadioBtn_"+key+"' />");
                });
                
                }else{ 
                
                 s.slider({
                  min:1,
                  max:items.length,
                  animate:'slow',
                  stop: function(event, ui){ 
                            var pointer = ui.value-1;                 
                            jq('#statusRadioBtn_'+ ui.value).prop('checked', true); 
                            jq("label").css({'color':'rgb(34, 34, 34)'});
                            jq("label[for=statusRadioBtn_"+ pointer +"]").css({'color':'#e98824'}); 
                            if(status =='Proposed' || status =='Postponed') { 
                            changeStatus(items[ui.value-1]);
                            } else {
                            changeStatus(items[ui.value-1]);
                            }                           
                      }
                });
                jq("#changeStatus").addClass("slider3");
                jq.each(items, function(key,value){
                  var w = PointerT;
                  if(key === 0 || key === items.length-1)
                    w = PointerT/2;
                  jq("#legend").append("<label style='width: "+w+"%' for='statusRadioBtn_"+key +"'>"+value+"</label><input type='radio' name='gateStatus' value='"+value+"' id='statusRadioBtn_"+key+"' />");
                });
                }
                
                jq("#legend label").on("click", function(){
                    var lpos = jq("#legend label").offset().left;
                    jq("#legend label").css({'color':'#555555', 'font-weight':'normal'});
                    jq(this).css({'color':'#e98824','font-weight':'bold'});
                    jq("toolTipMsg:before").css("left",lpos+"px");  
                    if(status=="Postponed"){ 
                    jq(".slider4").find("label:first").off("click").css("cursor","default");                   
                    jq(".slider4").find("input[value=Postponed]").prop("checked", true);
                 }                 
                });
                
                 if(status=="Postponed"){ 
                    jq(".slider4").find("label:first").off("click").css("cursor","default");                   
                    jq(".slider4").find("input[value=Postponed]").prop("checked", true);
                 }
                        
                
                if(jq("label[for=statusRadioBtn_2]").text().indexOf("Stopped") != -1){
                    jq("label[for=statusRadioBtn_2]").css({'text-align':'right', 'right':'-30px'});
                }  
                             
                jq("input[type=radio][id^='statusRadioBtn_']").hide();
            
                if(status == "In Progress"){                
                 jq(".ui-slider-handle").css("left", "0%");
                 jq("label[for=statusRadioBtn_0]").css({'color':'#e98824'});
                }
                if(status == "Proposed"){
                 jq("label[for=statusRadioBtn_0]").css({'color':'#e98824'});
                }
                if(status == "Postponed"){                
                 jq(".ui-slider-handle").css("left", "66.66%");
                 jq("label[for=statusRadioBtn_2]").css({'color':'#e98824'});
                }
                 if(status == "Stopped"){                
                 jq(".ui-slider-handle").css("left", "100%");
                 jq("label[for=statusRadioBtn_2]").css({'color':'#e98824'});
                }
            });
                  
           function GotoParentPage(){
            
            var url =  window.top.location.href;
            if(window.location.search.indexOf('ipmProjectOverview') > -1){
                window.top.location.href = '/apex/ipmProjectOverview?id={!projectId}';
            }else{
             if(status == "Stopped" && makeValid == true){
                    window.top.location.href='/apex/ipmProjectOverview?id={!projectId}';  
                  //  alert(jq("input[name=gateStatus]").val());                      
             }
             else if(status == "Proposed" && makeValid == true){
             //alert('ok');
            sendemailtoGK();  
            //alert('ok');  
                    window.top.location.href='/apex/ipm_GateDocument?id={!projectId}'; 
                   // alert("1");     
             }
             else if(status == "Postponed" && makeValid == true){
                     window.top.location.href='/apex/ipm_GateDocument?id={!projectId}';
                   //  alert("2");     
             } 
             else if(status == "Approved" && makeValid == true){                           
                window.top.location.href='/apex/ipm_GateDocument?id={!projectId}';
                sendemailtoGK();
                
                //alert("3");
            }
           }
        }          
        </script>
</apex:page>