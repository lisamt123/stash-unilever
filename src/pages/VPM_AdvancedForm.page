<apex:page standardController="VPM_PurchasingRequests__c"  extensions="flowController,VPM_PurchaseRequestsControllerExtension" standardStylesheets="true" sidebar="false" >
<apex:stylesheet value="{!URLFOR($Resource.vpmbootstrapresources, 'vpmbootstrapresources/bootstrap.css')}" />
<apex:stylesheet value="{!URLFOR($Resource.vpmstyles, 'vpmstyles.css')}" />
<apex:stylesheet value="{!URLFOR($Resource.vpmadvancedformcss)}" />
<apex:includeScript value="{!$Resource.vpmjqueryresources}"/>
<apex:includeScript value="{!URLFOR($Resource.vpmjqueryresources, 'vpmjqueryresources/jquery-1.12.4.js')}"/>
<script type = "text/javascript">
      $(document).ready(function(){
        var flag;
        var criteria1 = "{!VPM_PurchasingRequests__c.VPM_Status__c}"; 
        var criteriaId = "{!VPM_PurchasingRequests__c.Id}";
        var flsInCountry = "{!VPM_PurchasingRequests__c.VPM_FLSInCountryReqVendor__c}";
        var Islock = "{!VPM_PurchasingRequests__c.VPM_IsLock__c}";
        $('input[type="submit"],input[type="button"]').css('background-color','#0275d8 !important');
         /* Remoting Manager Methods*/
         /*Visualforce.remoting.Manager.invokeAction('VPM_PurchaseRequestsControllerExtension.checkLoggedInUserRole',
            function(userRole, event){
               debugger;
            });*/
          
          
         Visualforce.remoting.Manager.invokeAction('VPM_PurchaseRequestsControllerExtension.checkForBusinessReqUser',
            function(results, event){
                debugger;
                if(results.userRole=="FLS" && criteria1=="FLS Review") {
                     debugger;
                    removeStyleSheets();
                    $("#detailPage").show();
                    alert("Please Approve / Reject the Request before completing the Advanced Form.");
                 }
                 else if(flsInCountry=="true" && results.brUser=="true" && criteria1=="Draft Request")
                 {
                     debugger;
                    //document.getElementById('{!$Component.theForm}').elements['{!$Component.hiddenField}'].value = flag;
                    //$($('input[id*="hdnField"]')[0]).attr("value",flag);
                     if((document.referrer.indexOf('apex/VPM_AdvancedForm') == -1 && document.referrer.indexOf('VPM_GoldenData1') == -1)|| localStorage.getItem("cancelClicked"))
                        {
                            debugger;
                         flag = confirm("Please note if you complete and submit the Advanced Form, you will bypass your Front Line Services team and the request will route straight to approver/s.");
                    
                         if(flag){
                              localStorage.removeItem("cancelClicked");
                             $("#advForm").show();
                             domManipulations();
                             }
                        else{
                            debugger;
                              localStorage.setItem("cancelClicked",true);
                            removeStyleSheets();
                            $("#detailPage2").show();
                            }
                        }
                        else
                        {
                            debugger;
                         $("#advForm").show();
                         domManipulations();
                        }
                }
                else if (!Islock)
                {
                    alert('Record is in Approval...');
                    //return false;
                }
                    else{ //if(criteria1!="FLS Review")
                    domManipulations();
                    $("#advForm").show(); 
                    //$("#detailPage").hide();
               
                } 
           });
    });
    function removeStyleSheets(){
          $('link[href*="vpmadvancedformcss"]').remove();
            $('link[href*="bootstrap"]').remove();
            $('link[href*="vpmstyles"]').remove();
    }
    function domManipulations(){
        var el = $('tr>td.pbTitle');
        var savedRow = '';
        var numberOfTextFields = $('.detailList input[type="text"]').length;
        var spanToAlign = $('span[id*="VPM_MaintainTypeInfo"]');
        var maintainRadioBtns =$('span[id*="VPM_MaintainTypeInfo"]').length>0 ? $('span[id*="VPM_MaintainTypeInfo"]') : $('span[id*="VPM_Maintain2TypeInfo"]');
        var vendorDetailHeader = $('span[id*="VPM_CreateVendorDetailInfo"]');
        var maintainVendorHeader= $('span[id*="VPM_Maintain1VendorDetailsScreenInfo"]');
        var purchasingTab = $('#tabBar>li[class*="VPM_PurchasingRequests"]');
        var alignErrorMsg = $('span[id*="VPM_UnBlockUndeleteMessage"]');
        debugger;
       
        
        $('span[id*="VendorSearchInstr"],span[id*="VPM_MaintainExtendInstr"]').find('i').css("font-style","normal");
        $(purchasingTab).css("background-color","#0275D8");
        $('input[type="button"],input[type="submit"],button').addClass("btn-primary");
        
        $(vendorDetailHeader).find("b").addClass('emphasizeHeader');
        $(maintainVendorHeader).find("b").addClass('emphasizeHeader');
        $('span[id*="VPM_ReqestBriefDisplayText"]').find("b").addClass("emphasizeHeader");
        $('span[id*="VPM_BankDetailDisplaName"]').find("b").addClass("emphasizeHeader");
        $('span[id*="VPM_PaymentTermDisplay"]').find("b").addClass("emphasizeHeader");
        $('span[id*="VPM_FinancailDisplayText"]').find("b").addClass("emphasizeHeader");
        $('span[id*="CreateRegionSpecific"]').addClass("emphasizeHeader").css('font-weight','bold');
        
        $(".FlowPageBlockBtns").siblings().remove();
        /*  to align status and type side by side instead of one stacking both one above the other  */
        $(spanToAlign).css("float","left");
        var allDivs =$(spanToAlign).find('div');
        if($(allDivs[2]).find('font').text().indexOf('Status')!=-1)
            $(allDivs[2]).css({"float":"left"},{"margin-left":"6em"});
         
         if($(".interviewDisplayTextRow b").text().indexOf("Type") > -1){
                savedRow = $(".interviewDisplayTextRow")[1];
                savedRow && savedRow!=null ? $(savedRow ).remove():'';
             $(savedRow).insertBefore($(".interviewDisplayTextRow")[0]);
             $($(".interviewDisplayTextRow")[0]).css("display","table-cell");
            
             }
         if($(maintainRadioBtns).find("span").text().indexOf("Maintain") > -1){
            savedRow = $(maintainRadioBtns).find("span");
            if($(maintainRadioBtns).find("div").text().indexOf("Status") > -1){
                $(savedRow).insertBefore($(maintainRadioBtns).find("div:last-child"));
            }
            $(maintainRadioBtns).find("div:nth-child(3)").addClass("statusAlignment");
            $(maintainRadioBtns).find("span").addClass("typeAlignment");
              if($(".interviewDisplayTextRow font").text().indexOf("Extend") > -1){
                    $($(".interviewDisplayTextRow")[1]).css({"float": "right",
                                                          "position": "relative",
                                                          "right": "22.5em"});
             }
            else{
                 $(maintainRadioBtns).find("span").css({"left":"12em","top":"-1em"});
            }
        }
        
        /*  *****  */
        /* to divide fields into 2 columns */
        if(numberOfTextFields > 10){
            var remainingRows = [];
            var toRemove ='';
            for(var i=(Math.round(numberOfTextFields/2));i<numberOfTextFields;i++){
                toRemove = $('.detailList input[type="text"]')[i]; 
                remainingRows.push($(toRemove).closest('tr'));
            }

            for(var j=0,i=2;j<remainingRows.length,i<=$('.detailList tr').length;j++,i++){
                 var row = ($('.detailList tr')[i]);
                if(row && row!=[]){
                 $(row).find(".labelCol.last.empty").remove();
                 $(row).find(".dataCol.last.empty").remove();
                 if(remainingRows[j] && remainingRows[j].children()){
                    $(row).append(remainingRows[j].children());
                 }
               }
            }
        }
        /*  *****  */
         /*  Change text of 'Previous Button'   */
         var buttonLength = $('input[type="submit"],input[type="button"],button').length;
         for(var i=0;i<buttonLength;i++){
            if($('input[type="submit"],input[type="button"],button')[i].value == 'Previous')
                $('input[type="submit"],input[type="button"],button')[i].value = 'Menu/Previous';                
         }
        /*  *****  */
        
         if($(alignErrorMsg) && $(alignErrorMsg)!=[]){
                $(alignErrorMsg).closest('tr').css('display','table-row').append('<br>');
                $(alignErrorMsg).closest('td').append('<br>');
        }
    }
    function openPopup(page){
        window.open('/apex/VPM_AttachmentSectionPopUp','Table','toolbar=yes, scrollbars=no, toolbar=no, menubar=no, height=500,width=1230, top=70, left=70');
        return false;
    }
    function showAttachments(id){
        window.open('/apex/VPM_AttachFiles?id='+id,'Table','toolbar=yes, scrollbars=no, toolbar=no, menubar=no, height=500,width=1230, top=70, left=70'); 
    }
    </script>
   <div id="advForm" style="display: none;">
    <flow:interview name="VPM_PurchasingRequestAdvanceForm" interview="{!flBatch}"  finishLocation="{!prFinishLocation}">
        <apex:param name="VPM_PurchasingRequestID" value="{!VPM_PurchasingRequests__c.Id}"/>    
    </flow:interview>
       
       <br/>
       <apex:outputLink onclick="showAttachments('{!VPM_PurchasingRequests__c.Id}'); return false;"
         rendered="{!VPM_PurchasingRequests__c.Id != null && VPM_PurchasingRequests__c.Id != '' && 
                   VPM_PurchasingRequests__c.VPM_Status__c != 'FLS Review'}">Supporting Documents</apex:outputLink>
       <br/>
       <apex:outputLink onclick="openPopup('{!$Page.VPM_AttachmentSectionPopUp}');return false;"
                         rendered="{!VPM_PurchasingRequests__c.VPM_Status__c != 'FLS Review'}">Help for uploading documents</apex:outputLink>
   
    </div>
    <div id="detailPage" style="display:none;">
        <!--apex:detail subject="{!VPM_PurchasingRequests__c.Id}"  showChatter="true" /-->
        <apex:detail subject="{!VPM_PurchasingRequests__c.Id}" rendered="{!VPM_PurchasingRequests__c.VPM_Status__c == 'FLS Review'}"/>
    </div>
    <div id="detailPage2" style="display:none;">
        <apex:detail subject="{!VPM_PurchasingRequests__c.Id}" />
    </div>    
    
    <!-- rendered="{!(VPM_PurchasingRequests__c.VPM_Status__c == 'FLS Approved' ||
                              VPM_PurchasingRequests__c.VPM_Status__c == 'Draft Request')}" -->

    <!--div>
        <apex:outputLink onclick="showAttachments('{!VPM_PurchasingRequests__c.Id}'); return false;"
         rendered="{!VPM_PurchasingRequests__c.Id != null && VPM_PurchasingRequests__c.Id != '' && 
                   VPM_PurchasingRequests__c.VPM_Status__c != 'FLS Review'}">Supporting Documents</apex:outputLink>
    </div>
    <br/>
    <div>
        <apex:outputLink onclick="openPopup('{!$Page.VPM_AttachmentSectionPopUp}');return false;"
                         rendered="{!VPM_PurchasingRequests__c.VPM_Status__c != 'FLS Review'}">Help for uploading documents</apex:outputLink>
    </div-->
    <!--apex:relatedList subject="{!VPM_PurchasingRequests__c}" list="CombinedAttachments">
    <apex:facet name="footer">
        <apex:outputLink onclick="openPopup('{!$Page.VPM_AttachmentSectionPopUp}');return false;">Help for uploading documents</apex:outputLink>
    </apex:facet>
    </apex:relatedList-->
    
    <!--apex:form >
        <apex:inputHidden id="hdnField" value="{!flsInCountryFlag}"/>
    </apex:form-->
    
    <!--apex:detail subject="{!VPM_PurchasingRequests__c.Id}" showChatter="true"
                 rendered="{!(VPM_PurchasingRequests__c.VPM_Status__c != 'FLS Approved' &&
                              VPM_PurchasingRequests__c.VPM_Status__c != 'Draft Request')}" /-->
</apex:page>