<apex:page showHeader="false" docType="html-5.0" sidebar="false" controller="Oblix_CampaignSummaryController" standardStylesheets="true" action="{!checkUserHasPermissionToSOW}">
    <apex:composition template="Oblix_OuterPageTemplate">
        <apex:define name="top_breadcrumb">
            <a href="/apex/oblix_sowmain">SWOP Home</a>&nbsp;<span>&#9658;</span>&nbsp;<a href="/apex/oblix_sowmaindetail?sowId={!selected_sow.Id}">{!selected_sow.Name}</a>&nbsp;<span>&#9658;</span>&nbsp;{!selected_project.Name}
        </apex:define>

        <apex:define name="header_text">
            {!selected_project.Name} summary
        </apex:define>

        <apex:define name="top_option_links">
            <apex:outputPanel rendered="{!IF(can_edit_campaign,true,false)}">
                <apex:outputLink value="/apex/Oblix_CampaignCreate?projectId={!selected_project.Id}" >Edit Campaign</apex:outputLink>&nbsp;&nbsp;|&nbsp;&nbsp;
            </apex:outputPanel>
            <apex:outputPanel rendered="{!IF(can_edit_campaign,true,false)}">
                <a href="">Clone Campaign</a>&nbsp;&nbsp;|&nbsp;&nbsp;
            </apex:outputPanel>
            <apex:outputPanel rendered="{!IF(can_edit_campaign,true,false)}">
                <a href="#" onclick="if (confirm('are you sure you want to delete this campaign?')){deleteCampaign();blockme();}">Delete Campaign</a>
            </apex:outputPanel>
        </apex:define>

        <apex:define name="top_right_panel">
                    <table class="SOW_header_value_summary">
                        <tr>
                            <td rowspan="2">
                                <apex:outputPanel rendered="{!can_adjust_fee}">  
                                    <button type="button" class="btn btn-danger btn-xs create_SOW_button btn_chevron btn_adjust" data-toggle="modal" data-target="#adjustFeeModal">ADJUST %</button>  
                                </apex:outputPanel>  
                            </td>
                            <td class="SOW_header_value_title">Campaign Fees Total</td>
                            <td class="SOW_header_value">
                                <h2>€
                                    <apex:outputText value="{0, number,###,###,##0}">
                                        <apex:param value="{!stage_identifier.sow_project_in_scope.Campaign_Fees_Total__c}" />
                                    </apex:outputText>
                                </h2>
                            </td>
                        </tr>
                        <tr>
                            <td class="SOW_header_value_subtitle">Fees to be Paid in Current FY</td>
                            <td class="SOW_header_value_subvalue">
                                    €<apex:outputText value="{0, number,###,###,##0}">
                                        <apex:param value="{!stage_identifier.i_fees_for_this_financial_year}" />
                                    </apex:outputText>
                            </td>
                        </tr>
                    </table>
        </apex:define>

        <apex:define name="body_content">
  
   <!--            Adjust fee modal-->
           <apex:outputPanel Id="adjustFeeModalId">
            <div class="modal fade adjust_fee_modal" tabindex="-1" role="dialog" aria-labelledby="adjustFee" id="adjustFeeModal">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                            <h1 class="modal_window_title" id="gridSystemModalLabel">Adjust Fee</h1>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-lg-8 col-lg-offset-2">
                                    <div class="row">
                                        <div class="col-lg-8">
                                            <p class="modal_current_text green_text">Current % allocation of total<br/>campaign fee to be paid this FY</p>
                                        </div>
                                        <h1 class="green_text">
                                                <apex:outputText value="{!stage_identifier.i_percentage_of_fee_this_year}" ></apex:outputText> 
                                                <apex:outputLabel rendered="{!stage_identifier.i_percentage_of_fee_this_year <> null}"> %</apex:outputLabel>       
                                         </h1>
                                    </div>
                                    <div class="row">
                                        <div class="col-lg-7">
                                            <p class="modal_adjust_text">Adjust % allocation for this FY to</p>
                                        </div>
                                        <h1>
                                        <apex:input type="number" id="AdjustPercentage" styleClass="adjust_allocation_box"  value="{!PercentToAdjust}"/>
                                        
                                        %</h1>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <div class="modal_button_align">
                                <button type="button" class="btn btn_cross btn_cancel" data-dismiss="modal">CANCEL</button>
                                <!--<button type="button" class="btn btn-primary btn_check btn_save_changes">SAVE CHANGES</button>-->
                                <apex:commandButton action="{!AdjustFee}" styleClass="btn btn-primary btn_check btn_save_changes" value="SAVE CHANGES" />
                            </div>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
            </div><!-- /.modal -->
          </apex:outputPanel>
<!--            Adjust fee modal finish-->

             <hr class="divider" />    
            <div class="row">
                <div class="col-lg-9 confirm_assets_accordion">
                    <div class="chevron_width_control">
                        <c:Oblix_CampaignStage StageIdentifier="{!stage_identifier}" AutoSave="true" Id="campaign_stage_component" /> 
                    </div>             
                        <div class="campaign_summary_info_table">
                            <table class="campaign_summary_information camp_sum_table_left_width">
                                <tr>
                                    <td class="campaign_summary_information_titles">Last Updated</td>
                                    <td colspan="2">
                                        <apex:outputText value="{0,date,MM'/'dd'/'yyyy}">
                                            <apex:param value="{!selected_project.LastModifiedDate}" /> 
                                        </apex:outputText> by {!selected_project.LastModifiedBy.Name}</td>
                                
                                </tr>
                                <tr>
                                    <td class="campaign_summary_information_titles cell_text_top_align">Agency Hub Split</td>
                                    <td>
                                        <apex:repeat value="{!selected_project.Marketing_SOW_Project_Splits__r}" var="hub_splits" >
                                            {!hub_splits.OblixCountry__r.Name}<br/>
                                        </apex:repeat>
                                    </td>
                                    <td>    
                                        <apex:repeat value="{!selected_project.Marketing_SOW_Project_Splits__r}" var="hub_splits" >
                                            {!hub_splits.Percentage__c}%<br/>
                                        </apex:repeat>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="campaign_summary_information_titles">Clusters / Countries</td>
                                    <td colspan="2" class="expandMore campaign_summary_countries_cell_width">{!selected_project.Selected_Countries__c}</td>
                                </tr>
                                <tr>
                                    <td class="campaign_summary_information_titles">Investment Priority</td>
                                    <td colspan="2">{!selected_project.Innovation_Projects__c} &nbsp;&nbsp;&nbsp; <apex:outputText value="{!mapTurnoverToSize[selected_project.Brand_Led_Growth__c]}" rendered="{!selected_project.Brand_Led_Growth__c <> null}"></apex:outputText></td>
                                </tr>
                                <tr>
                                    <td class="campaign_summary_information_titles">Campaign idea</td>
                                    <td colspan="2">{!selected_project.Campaign_Idea__c}</td>
                                </tr>
                                <tr>
                                    <td class="campaign_summary_information_titles">Geographic scale</td>
                                    <td colspan="2">{!selected_project.Project_Scale_1__c}</td>
                                </tr>
                                <tr>
                                    <td class="campaign_summary_information_titles">Agency hubs</td>
                                    <td colspan="2">{!selected_project.Project_Scale_2__c}</td>
                                </tr>
                            </table>
                            <table class="campaign_summary_information camp_sum_table_right_width" id="assets_list">
                                <tr>
                                    <td class="campaign_summary_information_titles camp_sum_table_title__width">Platform</td>
                                    <td colspan="2">{!selected_project.Platform__c}</td>
                                </tr>
                                <tr>
                                    <td class="campaign_summary_information_titles camp_sum_table_title__width">Campaign priority</td>
                                    <td colspan="2">{!selected_project.Project_Priority__c}</td>
                                </tr>
                                <tr>
                                    <td class="campaign_summary_information_titles cell_text_top_align camp_sum_table_title__width">Timeline dates</td>
                                    <td>
                                        <apex:outputText value="Campaign start" rendered="{!NULL<>selected_project.Project_Start_Date__c}"><br/></apex:outputText>
                                        <apex:outputText value="Campaign completion" rendered="{!NULL<>selected_project.Project_Completion_Date__c}"><br/></apex:outputText>
                                        <apex:outputText value="First air date" rendered="{!NULL<>selected_project.First_Air_Date__c}"><br/></apex:outputText>
                                        <apex:outputText value="Production completion " rendered="{!NULL<>selected_project.Production_Completion_Date__c}"><br/></apex:outputText>
                                        <apex:outputText value="BET first release" rendered="{!NULL<>selected_project.BET_first_release__c}"><br/></apex:outputText>
                                        <apex:outputText value="Date for assets in BET" rendered="{!NULL<>selected_project.Date_for_Assets_to_be_in_BET__c}"><br/></apex:outputText>
                                        <apex:outputText value="Preview Date" rendered="{!NULL<>selected_project.Preview_Date__c}"><br/></apex:outputText>
                                        <apex:outputText value="Start of TV production" rendered="{!NULL<>selected_project.Start_of_TV_production__c}"><br/></apex:outputText>
                                        <apex:outputText value="Final release" rendered="{!NULL<>selected_project.Final_release__c}"><br/></apex:outputText>
                                        <apex:outputText value="Live date" rendered="{!NULL<>selected_project.Live_Date__c}"><br/></apex:outputText>
                                        <apex:outputText value="Live date/asset delivery" rendered="{!NULL<>selected_project.Live_date_Asset_delivery__c}"><br/></apex:outputText>

                                    </td>
                                    <td>

                                        <apex:outputText value="{0,date,MM'/'dd'/'yyyy}" rendered="{!NULL<>selected_project.Project_Start_Date__c}">
                                            <apex:param value="{!selected_project.Project_Start_Date__c}" /> <br/>
                                        </apex:outputText>


                                        <apex:outputText value="{0,date,MM'/'dd'/'yyyy}" rendered="{!NULL<>selected_project.Project_Completion_Date__c}">
                                            <apex:param value="{!selected_project.Project_Completion_Date__c}" /> <br/>
                                        </apex:outputText>


                                        <apex:outputText value="{0,date,MM'/'dd'/'yyyy}" rendered="{!NULL<>selected_project.First_Air_Date__c}">
                                            <apex:param value="{!selected_project.First_Air_Date__c}" /> <br/>
                                        </apex:outputText>

                                        <apex:outputText value="{0,date,MM'/'dd'/'yyyy}" rendered="{!NULL<>selected_project.Production_Completion_Date__c}">
                                            <apex:param value="{!selected_project.Production_Completion_Date__c}" /> <br/>
                                        </apex:outputText>

                                        <apex:outputText value="{0,date,MM'/'dd'/'yyyy}" rendered="{!NULL<>selected_project.BET_first_release__c}">
                                            <apex:param value="{!selected_project.BET_first_release__c}" /> <br/>
                                        </apex:outputText>

                                        <apex:outputText value="{0,date,MM'/'dd'/'yyyy}" rendered="{!NULL<>selected_project.Date_for_Assets_to_be_in_BET__c}">
                                            <apex:param value="{!selected_project.Date_for_Assets_to_be_in_BET__c}" /> <br/>
                                        </apex:outputText>

                                        <apex:outputText value="{0,date,MM'/'dd'/'yyyy}" rendered="{!NULL<>selected_project.Preview_Date__c}">
                                            <apex:param value="{!selected_project.Preview_Date__c}" /> <br/>
                                        </apex:outputText>

                                        <apex:outputText value="{0,date,MM'/'dd'/'yyyy}" rendered="{!NULL<>selected_project.Start_of_TV_production__c}">
                                            <apex:param value="{!selected_project.Start_of_TV_production__c}" /> <br/>
                                        </apex:outputText>

                                        <apex:outputText value="{0,date,MM'/'dd'/'yyyy}" rendered="{!NULL<>selected_project.Final_release__c}">
                                            <apex:param value="{!selected_project.Final_release__c}" /> <br/>
                                        </apex:outputText>

                                        <apex:outputText value="{0,date,MM'/'dd'/'yyyy}" rendered="{!NULL<>selected_project.Live_Date__c}">
                                            <apex:param value="{!selected_project.Live_Date__c}" /> <br/>
                                        </apex:outputText>

                                        <apex:outputText value="{0,date,MM'/'dd'/'yyyy}" rendered="{!NULL<>selected_project.Live_date_Asset_delivery__c}">
                                            <apex:param value="{!selected_project.Live_date_Asset_delivery__c}" /> <br/>
                                        </apex:outputText>

                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="3"><span class="campaign_summary_information_titles" >Description</span><br/>
                                    <div class="expandMore">{!selected_project.Description__c}</div><!-- <a href="">more</a> --></td>
                                </tr>
                                <tr>
                                    <td colspan="3"><span class="campaign_summary_information_titles" >Jobs to be done</span><br/>
                                    <div class="expandMore">{!selected_project.Jobs_to_be_Done__c}</div><!-- <a href="">more</a> --></td>
                                </tr>
                            </table>
                        </div>    
                    </div>   
                </div>
                <hr class="divider" />
            <apex:outputPanel id="assets_panel" >
            <div class="row">
                <div class="col-lg-12 ">
                    <p class="page_bold_subheading">Campaign Assets</p>
                    <apex:outputPanel id="addAssetButtonPanel">
                        <apex:commandButton rendered="{!can_edit}" value="{!If(can_manage_asset,'ADD ASSET','VIEW BASKET')}" action="{!addAssetAction}" styleClass="btn btn-primary btn-xs pull-right  btn_plus btn_campaign_add_asset" onclick="blockme()" />
                    </apex:outputPanel>
                        <div class="Oblix_table" id="Oblix_DashId">
                                <table class="table table-striped" id="sowListTable">
                                    <thead>
                                        <tr>
                                            <apex:repeat value="{!$ObjectType.Oblix_Project_Assets__c.FieldSets.Oblix_Campaign_Summary}" var="field_name">
                                               
                                                <th style="{!IF(field_name.Label == 'Record ID','display:none;','')}" >
                                                    <apex:outputLabel value="{!field_name.label}"/>
                                                </th>
                                               
                                            </apex:repeat>
                                            <apex:outputPanel id="deleteTableHeader" rendered="{!IF(can_manage_asset,true,false)}">
                                            <th></th>
                                            </apex:outputPanel>
                                        </tr>
                                    </thead>
                                    <tbody>

                                        <apex:repeat value="{!liso_assets}" var="asset">
                                            <apex:variable value="{!asset['Id']}" var="asset_id"/>
                                            <tr>
                                                <apex:repeat value="{!$ObjectType.Oblix_Project_Assets__c.FieldSets.Oblix_Campaign_Summary}" var="field_name">
                                                    <!-- <td style="{!IF(field_name.Label == 'Record ID','display:none;','')}" onclick="viewAssetFunction('{!asset_id}'); blockme();"> -->
                                                    <td style="{!IF(field_name.Label == 'Record ID','display:none;','')}">
                                                        <apex:outputText value="{0, number, ###,###.##}" rendered="{!(asset[field_name] != null && field_name.Type =='double')}">
                                                            <apex:param value="{!asset[field_name]}" />
                                                        </apex:outputText> 
                                                        
                                                        <apex:outputText value="{0,date,E','dd MMM yyyy}" rendered="{!(asset[field_name] != null && field_name.Type =='dateTime')}" style="tableRow">
                                                            <apex:param value="{!asset[field_name]}" />
                                                        </apex:outputText>

                                                        <!-- <apex:outputText value="{!asset[field_name]}" rendered="{!(asset[field_name] != null && field_name.Type !='date' && field_name.Type !='double' && !contains(field_name.Label,'Name'))}" style="tableRow" styleClass="asset_description" /> -->
                                                        
                                                        <!-- <apex:outputLink value="{!$Page.Oblix_CampaignAddAsset}?projectId={!project_id}&assetId={!asset['Id']}" rendered="{!(asset[field_name] != null && field_name.Type !='date' && field_name.Type !='double' && contains(field_name.Label,'Name')&& (hasEditAccess))}" style="tableRow" target="_self" >{!asset[field_name]}  </apex:outputLink> -->
                                                        <!--apex:outputPanel rendered="{!IF(hasEditAccess == false,false,true)}">
                                                            
                                                        </apex:outputPanel-->
                                                        <apex:outputText value="{!asset[field_name]}" rendered="{!(asset[field_name] != null && field_name.Type !='date' && field_name.Type !='double')}" style="tableRow" styleclass="expandMore">  </apex:outputText>
                                                    </td>
                                                </apex:repeat>
                                                <apex:outputPanel id="deleteTableDefinition" rendered="{!IF(can_manage_asset,true,false)}">
                                                    <td>
                                                        
                                                            <a href="#" id="delete_button" onclick="if (confirm('are you sure you want to delete this asset?')){removeAsset('{!asset.Id}');blockme();}"> <apex:image onclick="" url="{!URLFOR($Resource.Oblix_SwopAssets, 'Oblix_SwopAssets/images/redcross.png')}" width="12" height="12" alt="Delete"/>
                                                        </a>

                                                    </td>
                                                
                                                </apex:outputPanel>
                                            </tr>
                                        </apex:repeat>
                                    </tbody>
                                </table> 
                        </div>                  
                </div>
            </div>
            </apex:outputPanel>
            <apex:actionFunction name="deleteCampaign" action="{!deleteCampaign}" oncomplete="unblockUI();"/>

            <apex:actionFunction action="{!removeAsset}" name="removeAsset" rerender="assets_panel,swop_top_panel,addAssetButtonPanel,deleteTableDefinition,deleteTableHeader" oncomplete="$.unblockUI();$('#sowListTable').DataTable({
                        'dom': 'lrtip',
                        'pagingType': 'full_numbers'
                    });location.reload();">
                <apex:param name="selected_asset_id" assignTo="{!selected_asset_id}" value="" />
            </apex:actionFunction>

            <apex:actionFunction rendered="{!can_edit}" name="viewAssetFunction" action="{!viewAsset}" rerender="assets_panel">
                <apex:param value="" assignTo="{!selected_asset_id}" name="ids" />
            </apex:actionFunction>

        </apex:define>
        <apex:define name="page_scripts">
            <script src="{!URLFOR($Resource.Oblix_SwopAssets, 'Oblix_SwopAssets/js/Oblix_CampaignSummary.js')}"/>
            <script type="text/javascript">
                
            </script>
            <!--<script>
                $(document).ready(function() {
                    $('.countriesSelected').readmore({
                        moreLink: '<a href="#">Read more</a>',
                        lessLink: '<a href="#">Close</a>',
                        collapsedHeight: 45,
                        blockCSS: 'display: block; width: 300px;',
                        afterToggle: function(trigger, element, expanded) {
                            if( expanded) { // The "more" link was clicked
                                $(this).width("width","300px");
                            }
                        }
                    });
                    // var table = $('#sowListTable').DataTable({
                    //     "dom": 'lrtip',
                    //     "pagingType": "full_numbers",
                    //     "bAutoWidth": false,
                    //     "aoColumns": [
                    //       { "sWidth": "0%" },
                    //       { "sWidth": "300px" },
                    //       { "sWidth": "50px" },
                    //       { "sWidth": "300px" },
                    //       { "sWidth": "50px" },
                    //       { "sWidth": "450px" },
                    //       { "sWidth": "50px" },
                    //       { "sWidth": "300px" }
                    //    ]
                    // });
                    var table = $('#sowListTable').DataTable({
                        "dom": 'lrtip',
                        'pagingType': 'full_numbers'
                    });
                    $('#searchBox').on('keyup', function() {
                        table.search(this.value).draw();

                    });
                    $('#sowListTable tbody').on('click', 'tr', function() {
                            //blockme();
                            $(this).toggleClass('selected');
                            $(this).addClass('bg_selected');

                            var ids = $('.selected span').html();
                            alert(ids);
                            viewAsset(ids);
                    });

                });
            </script>-->
        </apex:define>
    </apex:composition>
</apex:page>